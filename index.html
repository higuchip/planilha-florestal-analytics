<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha Florestal Analytics | Em Testes</title>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse para leitura de CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- html2canvas para exportar gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2E7D32;
            --primary-light: #4CAF50;
            --primary-dark: #1B5E20;
            --accent-color: #1976D2;
            --secondary-accent: #0D47A1;
            --error-color: #D32F2F;
            --warning-color: #FFA000;
            --text-color: #333333;
            --text-light: #757575;
            --background-color: #F5F8F5;
            --card-color: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-hover: 0 4px 8px rgba(0,0,0,0.15);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-title h1 {
            font-size: 28px;
            font-weight: 500;
        }
        
        .app-title .icon {
            font-size: 32px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .upload-section {
            background: var(--card-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed var(--primary-light);
            border-radius: var(--border-radius);
            padding: 40px;
            background: rgba(76, 175, 80, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            background: rgba(76, 175, 80, 0.1);
            border-color: var(--primary-color);
        }
        
        .upload-area.dragover {
            background: rgba(76, 175, 80, 0.15);
            border-color: var(--primary-dark);
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--primary-light);
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 18px;
            color: var(--text-color);
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: var(--text-light);
        }
        
        #fileInput {
            display: none;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            background: var(--card-color);
            padding: 0 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 16px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: var(--text-color);
        }
        
        .tab.active {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            background: var(--card-color);
            padding: 30px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, var(--card-color) 0%, rgba(76, 175, 80, 0.05) 100%);
            padding: 20px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--shadow);
        }
        
        .summary-card h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .summary-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .summary-card .unit {
            font-size: 14px;
            color: var(--text-light);
            margin-left: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        tr:hover {
            background: rgba(76, 175, 80, 0.05);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .btn-secondary {
            background: var(--accent-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--secondary-accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--primary-dark);
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }
        
        .info-box {
            background: rgba(25, 118, 210, 0.05);
            border-left: 4px solid var(--accent-color);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }
        
        .info-box p {
            margin: 5px 0;
            color: var(--text-color);
        }
        
        .hidden {
            display: none !important;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .tabs {
                flex-wrap: wrap;
                padding: 10px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 14px;
            }

            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .chart-container {
                height: 300px;
            }

            .export-buttons {
                flex-direction: column;
            }

            /* Responsivo para se√ß√£o informativa */
            .container > div:first-child {
                padding: 15px !important;
            }

            .container > div:first-child h3 {
                font-size: 16px !important;
            }

            .container > div:first-child > div:first-child {
                flex-direction: column !important;
                gap: 8px !important;
            }

            /* Responsivo para gr√°ficos de estrutura */
            .structure-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .structure-chart-container .chart-content {
                height: 300px !important;
                padding: 15px !important;
            }

            .structure-chart-container .chart-title {
                font-size: 16px !important;
            }

            .structure-chart-container .info-box {
                font-size: 12px !important;
                padding: 10px 15px !important;
            }

            /* Ajustar texto das estat√≠sticas para mobile */
            .structure-chart-container .info-box p {
                line-height: 1.4 !important;
                word-break: break-word !important;
            }

            /* Melhorar bot√µes de exporta√ß√£o em mobile */
            .export-buttons {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            .export-buttons .btn {
                width: 100% !important;
                justify-self: stretch !important;
            }

            /* Responsivo para rodap√© */
            footer > div > div:first-child {
                flex-direction: column !important;
                gap: 15px !important;
                text-align: center;
            }

            footer > div > div:first-child > div:last-child {
                font-size: 12px !important;
            }
        }
        
        #noDataMessage {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        #noDataMessage .icon {
            font-size: 64px;
            color: var(--border-color);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <div class="app-title">
                <span class="icon">üå≤üìà</span>
                <div>
                    <h1>Planilha Florestal Analytics</h1>
                    <div class="subtitle">Companheiro do Planilha Florestal App ‚Ä¢ An√°lise de dados coletados em campo</div>
                </div>
            </div>
            <div style="text-align: right; color: rgba(255,255,255,0.9); font-size: 12px;">
                <div style="margin-bottom: 4px;">
                    <strong>Planilha Florestal</strong>
                </div>
                <div style="opacity: 0.8;">
                    Analytics ‚Ä¢ üóã Em Testes
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Informa√ß√µes do Planilha Florestal -->
        <div style="background: linear-gradient(135deg, rgba(46, 125, 50, 0.05) 0%, rgba(25, 118, 210, 0.05) 100%);
                    border: 1px solid rgba(46, 125, 50, 0.2);
                    border-radius: var(--border-radius);
                    padding: 20px;
                    margin-bottom: 30px;
                    text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                <span style="font-size: 24px;">üå≤</span>
                <h3 style="margin: 0; color: var(--primary-color); font-size: 18px;">
                    Planilha Florestal Analytics - Ferramenta de An√°lise
                </h3>
                <span style="font-size: 24px;">üìä</span>
            </div>
            <p style="margin: 0; color: var(--text-color); font-size: 14px; line-height: 1.5;">
                Esta ferramenta complementa o <strong>Planilha Florestal App</strong> (PWA para coleta de dados em campo).
                Importe os arquivos CSV gerados pelo app de campo para realizar an√°lises fitossociol√≥gicas completas,
                incluindo par√¢metros estruturais, √≠ndices de diversidade, curvas de acumula√ß√£o e padr√µes espaciais.
            </p>
            <div style="margin-top: 12px; font-size: 12px; color: var(--text-light);">
                <strong>üí° Dica:</strong> Exporte seus dados do Planilha Florestal App em formato CSV e carregue aqui para an√°lise
            </div>
        </div>

        <div class="upload-section">
            <!-- Passo 1: Configurar √°rea -->
            <div id="stepConfig" style="padding: 30px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(25, 118, 210, 0.05) 100%); border-radius: 8px; border: 1px solid var(--primary-light); margin-bottom: 20px;">
                <h2 style="margin-top: 0; color: var(--primary-color); font-size: 20px; display: flex; align-items: center; gap: 10px;">
                    <span style="background: var(--primary-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px;">1</span>
                    Configura√ß√£o da √Årea Amostral
                </h2>
                <div style="display: flex; gap: 30px; align-items: flex-start; flex-wrap: wrap; margin-top: 20px;">
                    <div style="flex: 1; min-width: 200px;">
                        <label for="plotSize" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color);">
                            Tamanho da Parcela (m¬≤): <span style="color: var(--error-color);">*</span>
                        </label>
                        <input type="number" id="plotSize" value="400" min="1" step="0.1"
                               style="padding: 10px 14px; border: 2px solid var(--border-color); 
                                      border-radius: 6px; width: 100%; font-size: 16px;
                                      transition: border-color 0.3s;">
                        <small style="color: var(--text-light); display: block; margin-top: 5px;">
                            √Årea de cada unidade amostral
                        </small>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 10px; background: white; border-radius: 6px; border: 1px solid var(--border-color);">
                        <strong style="color: var(--primary-dark); display: block; margin-bottom: 8px;">Tamanhos comuns:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="size-preset" data-size="100" style="padding: 6px 12px; background: var(--background-color); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 14px;">100 m¬≤ (10√ó10)</button>
                            <button class="size-preset" data-size="400" style="padding: 6px 12px; background: var(--primary-light); color: white; border: 1px solid var(--primary-color); border-radius: 4px; cursor: pointer; font-size: 14px;">400 m¬≤ (20√ó20)</button>
                            <button class="size-preset" data-size="500" style="padding: 6px 12px; background: var(--background-color); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 14px;">500 m¬≤ (10√ó50)</button>
                            <button class="size-preset" data-size="600" style="padding: 6px 12px; background: var(--background-color); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 14px;">600 m¬≤ (20√ó30)</button>
                            <button class="size-preset" data-size="1000" style="padding: 6px 12px; background: var(--background-color); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 14px;">1000 m¬≤ (20√ó50)</button>
                        </div>
                    </div>
                </div>
                <div id="configStatus" style="margin-top: 15px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; color: var(--primary-dark); display: none;">
                    <strong>‚úì √Årea configurada:</strong> <span id="configStatusText"></span>
                </div>
            </div>
            
            <!-- Passo 2: Upload do arquivo -->
            <div id="stepUpload" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
                <h2 style="margin-top: 0; color: var(--text-light); font-size: 20px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <span style="background: var(--border-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px;">2</span>
                    Upload do Arquivo
                </h2>
                <div class="upload-area" id="uploadArea" style="border-color: var(--border-color);">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Clique ou arraste o arquivo CSV aqui</div>
                    <div class="upload-hint">Formato aceito: CSV exportado do Planilha Florestal App</div>
                    <div style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                        Tamb√©m aceita CSVs de outros invent√°rios com estrutura compat√≠vel
                    </div>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".csv" disabled>
            
            <div id="areaInfo" style="margin-top: 20px; padding: 15px; background: rgba(25, 118, 210, 0.05); border-radius: 8px; border: 1px solid rgba(25, 118, 210, 0.2); display: none;">
                <h3 style="margin-top: 0; color: var(--accent-color); font-size: 16px;">Informa√ß√µes da Amostragem</h3>
                <div id="areaInfoContent"></div>
            </div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="tabs">
                <button class="tab active" data-tab="validation">‚úì Valida√ß√£o</button>
                <button class="tab" data-tab="summary">Resumo</button>
                <button class="tab" data-tab="structure">Estrutura</button>
                <button class="tab" data-tab="phytosociology">Fitossociologia</button>
                <button class="tab" data-tab="accumulation">Curva de Acumula√ß√£o</button>
                <button class="tab" data-tab="diversity">Diversidade</button>
                <button class="tab" data-tab="spatial">Padr√£o Espacial</button>
                <button class="tab" data-tab="biomass">Biomassa</button>
            </div>

            <!-- ABA DE VALIDA√á√ÉO -->
            <div id="validation" class="tab-content active">
                <h2 class="section-title">Valida√ß√£o e Corre√ß√£o de Dados</h2>

                <div style="background: rgba(255, 160, 0, 0.1); border-left: 4px solid var(--warning-color); padding: 15px 20px; border-radius: var(--border-radius); margin-bottom: 30px;">
                    <p style="margin: 0;"><strong>‚ö†Ô∏è Importante:</strong> Revise os dados antes de prosseguir com as an√°lises. Corrija nomes de esp√©cies e verifique poss√≠veis outliers nas medi√ß√µes.</p>
                </div>

                <!-- Corre√ß√£o Bot√¢nica -->
                <div style="margin-bottom: 40px;">
                    <h3 class="section-title" style="font-size: 18px;">1. Corre√ß√£o Bot√¢nica</h3>

                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="searchSpecies" placeholder="Buscar esp√©cie..."
                               style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <button class="btn btn-secondary" onclick="sortSpeciesAlpha()">
                            üî§ Ordenar A-Z
                        </button>
                        <button class="btn btn-secondary" onclick="sortSpeciesCount()">
                            üî¢ Ordenar por N
                        </button>
                    </div>

                    <div class="table-container">
                        <table id="speciesValidationTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">Sel.</th>
                                    <th>Esp√©cie Original</th>
                                    <th style="width: 100px;">N¬∞ Ind.</th>
                                    <th>Corre√ß√£o/Sin√¥nimo</th>
                                    <th style="width: 120px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="speciesTableBody"></tbody>
                        </table>
                    </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="applySpeciesCorrections()">
                            ‚úì Aplicar Corre√ß√µes
                        </button>
                        <button class="btn btn-secondary" onclick="mergeSelectedSpecies()">
                            üîÄ Mesclar Selecionadas
                        </button>
                        <button class="btn btn-secondary" onclick="exportSpeciesList()">
                            üì• Exportar Lista
                        </button>
                    </div>

                    <div id="correctionStatus" style="margin-top: 15px; padding: 10px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; color: var(--primary-dark); display: none;">
                    </div>
                </div>

                <!-- Detec√ß√£o de Outliers -->
                <div style="margin-bottom: 40px;">
                    <h3 class="section-title" style="font-size: 18px;">2. Detec√ß√£o de Outliers</h3>

                    <!-- Explica√ß√£o sobre outliers -->
                    <div style="background: rgba(25, 118, 210, 0.05); border-left: 4px solid var(--accent-color); padding: 15px 20px; border-radius: var(--border-radius); margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--accent-color);">üí° O que s√£o Outliers?</h4>
                        <p style="margin: 5px 0; font-size: 14px;">
                            <strong>Outliers</strong> s√£o valores de medi√ß√£o que se distanciam significativamente do padr√£o normal dos dados.
                            Podem indicar <strong>erros de medi√ß√£o</strong>, <strong>digita√ß√£o incorreta</strong> ou <strong>√°rvores com caracter√≠sticas excepcionais</strong>.
                        </p>
                        <ul style="margin: 10px 0 5px 20px; font-size: 14px; line-height: 1.4;">
                            <li><strong>IQR:</strong> Detecta valores fora do intervalo entre quartis (m√©todo conservador)</li>
                            <li><strong>Z-Score:</strong> Detecta valores al√©m de 3 desvios padr√£o da m√©dia (m√©todo mais rigoroso)</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; font-size: 13px; color: var(--text-light);">
                            <strong>Recomenda√ß√£o:</strong> Revise cada outlier individualmente - nem todos precisam ser removidos!
                        </p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="summary-card">
                            <h3>M√©todo de Detec√ß√£o</h3>
                            <select id="outlierMethod" style="width: 100%; padding: 8px; border: 2px solid var(--border-color); border-radius: 6px; margin-top: 10px;">
                                <option value="iqr">IQR (Intervalo Interquartil) - Conservador</option>
                                <option value="zscore">Z-Score (3 desvios padr√£o) - Rigoroso</option>
                            </select>
                        </div>
                        <div class="summary-card">
                            <h3>Outliers Detectados</h3>
                            <div class="value" id="outlierCount">0</div>
                            <small id="outlierInfo" style="font-size: 12px; color: var(--text-light); display: block; margin-top: 5px;"></small>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="detectOutliers()" style="margin-bottom: 15px;">
                        üîç Detectar Outliers
                    </button>
                    <span style="margin-left: 15px; font-size: 14px; color: var(--text-light);">
                        Clique para analisar valores suspeitos de DAP e Altura
                    </span>

                    <div class="table-container">
                        <table id="outliersTable">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Parcela</th>
                                    <th style="width: 90px;">ID √Årvore</th>
                                    <th>Esp√©cie</th>
                                    <th style="width: 90px;">CAP (cm)</th>
                                    <th style="width: 90px;">DAP (cm)</th>
                                    <th style="width: 90px;">Altura (m)</th>
                                    <th style="width: 100px;">Tipo Outlier</th>
                                    <th style="width: 180px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="outliersTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Explica√ß√£o das a√ß√µes -->
                    <div style="margin-top: 15px; padding: 10px; background: rgba(76, 175, 80, 0.05); border-radius: 4px; font-size: 13px; color: var(--text-light);">
                        <strong>A√ß√µes dispon√≠veis:</strong>
                        <span style="margin-left: 15px;">‚úèÔ∏è <strong>Editar:</strong> Corrigir valores de CAP/DAP ou Altura</span>
                        <span style="margin-left: 15px;">üóëÔ∏è <strong>Remover:</strong> Excluir √°rvore do banco de dados</span>
                        <br><strong>Nota:</strong> Outliers n√£o editados nem removidos ser√£o mantidos automaticamente nos dados finais.
                    </div>
                </div>

                <!-- Exportar dados validados -->
                <div style="text-align: center; padding: 20px 0; border-top: 2px solid var(--border-color); margin-top: 30px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--primary-dark);">üíæ Salvar Dados Validados</h4>
                    <button class="btn btn-secondary" onclick="exportCorrectedCSV()" style="font-size: 14px; padding: 12px 30px; margin-bottom: 20px;">
                        üì§ Exportar CSV Corrigido
                    </button>
                    <p style="margin: 0 0 20px 0; color: var(--text-light); font-size: 13px;">
                        Inclui todas as corre√ß√µes de esp√©cies e outliers aplicadas
                    </p>
                </div>

                <!-- Bot√£o para prosseguir -->
                <div style="text-align: center; padding: 20px 0; border-top: 1px solid var(--border-color);">
                    <button class="btn btn-primary" onclick="proceedToAnalysis()" style="font-size: 16px; padding: 15px 40px;">
                        ‚úì Dados Validados - Prosseguir para An√°lises
                    </button>
                    <p style="margin-top: 15px; color: var(--text-light); font-size: 14px;">
                        As corre√ß√µes ser√£o aplicadas automaticamente nas an√°lises
                    </p>
                </div>
            </div>

            <div id="summary" class="tab-content">
                <h2 class="section-title">Resumo dos Resultados</h2>
                <div class="summary-grid" id="summaryGrid"></div>
                <div class="info-box">
                    <h3>Informa√ß√µes do Invent√°rio</h3>
                    <p id="projectInfo"></p>
                </div>
            </div>

            <div id="structure" class="tab-content">
                <h2 class="section-title">Estrutura da Floresta</h2>
                <div class="structure-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div class="structure-chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Distribui√ß√£o Diam√©trica (DAP)</div>
                        </div>
                        <div class="chart-content" style="position: relative; height: 400px; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px;">
                            <canvas id="dapHistogram"></canvas>
                        </div>
                        <div class="info-box" style="margin-top: 15px;">
                            <p id="dapHistogramInfo"></p>
                        </div>
                    </div>
                    <div class="structure-chart-container">
                        <div class="chart-header">
                            <div class="chart-title">Distribui√ß√£o de Altura</div>
                        </div>
                        <div class="chart-content" style="position: relative; height: 400px; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px;">
                            <canvas id="heightHistogram"></canvas>
                        </div>
                        <div class="info-box" style="margin-top: 15px;">
                            <p id="heightHistogramInfo"></p>
                        </div>
                    </div>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportChart('dapHistogram')">
                        üì• Exportar Histograma DAP
                    </button>
                    <button class="btn btn-primary" onclick="exportChart('heightHistogram')">
                        üì• Exportar Histograma Altura
                    </button>
                </div>
            </div>

            <div id="phytosociology" class="tab-content">
                <h2 class="section-title">Tabela Fitossociol√≥gica</h2>
                <div class="table-container">
                    <table id="phytoTable"></table>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportTableToCSV()">
                        üì• Exportar Tabela CSV
                    </button>
                </div>
            </div>

            <div id="accumulation" class="tab-content">
                <h2 class="section-title">Curva de Acumula√ß√£o de Esp√©cies</h2>
                <div class="chart-container">
                    <canvas id="accumulationChart"></canvas>
                </div>
                <div class="info-box">
                    <h3>Interpreta√ß√£o</h3>
                    <p id="accumulationInterpretation"></p>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportChart('accumulationChart')">
                        üì• Exportar Gr√°fico
                    </button>
                </div>
            </div>

            <div id="diversity" class="tab-content">
                <h2 class="section-title">√çndices de Diversidade</h2>
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>√çndice de Shannon (H')</h3>
                        <div class="value" id="shannonIndex">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>Equabilidade de Pielou (J)</h3>
                        <div class="value" id="pielouIndex">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>Riqueza de Esp√©cies (S)</h3>
                        <div class="value" id="speciesRichness">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>Domin√¢ncia de Simpson (D)</h3>
                        <div class="value" id="simpsonIndex">-</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="diversityChart"></canvas>
                </div>
            </div>

            <div id="spatial" class="tab-content">
                <h2 class="section-title">Padr√£o Espacial - √çndice de Morisita</h2>
                <div class="chart-container">
                    <canvas id="spatialChart"></canvas>
                </div>
                <div class="table-container">
                    <table id="morisitaTable"></table>
                </div>
                <div class="info-box">
                    <h3>Interpreta√ß√£o</h3>
                    <p>√çndice de Morisita (I):</p>
                    <ul style="margin-left: 20px;">
                        <li>I > Limite de Agrega√ß√£o: Distribui√ß√£o agregada (agrupada)</li>
                        <li>I < Limite de Uniformidade: Distribui√ß√£o uniforme (regular)</li>
                        <li>Entre os limites: Distribui√ß√£o aleat√≥ria</li>
                    </ul>
                    <p style="margin-top: 10px;">Os limites s√£o calculados usando distribui√ß√£o qui-quadrado com Œ± = 0.05</p>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="exportChart('spatialChart')">
                        üì• Exportar Gr√°fico
                    </button>
                </div>
            </div>

            <!-- ABA DE BIOMASSA -->
            <div id="biomass" class="tab-content">
                <h2 class="section-title">Estimativa de Biomassa</h2>

                <div style="background: rgba(25, 118, 210, 0.05); border-left: 4px solid var(--accent-color); padding: 15px 20px; border-radius: var(--border-radius); margin-bottom: 30px;">
                    <p style="margin: 0;"><strong>‚ÑπÔ∏è Informa√ß√£o:</strong> Selecione um modelo alom√©trico para calcular a biomassa a√©rea (AGB) das √°rvores. Certifique-se que o conjunto de dados possui as vari√°veis necess√°rias.</p>
                </div>

                <!-- Sele√ß√£o do Modelo -->
                <div style="margin-bottom: 30px;">
                    <h3 class="section-title" style="font-size: 18px;">1. Sele√ß√£o do Modelo Alom√©trico</h3>

                    <div style="margin-bottom: 20px;">
                        <label for="modelSelection" style="display: block; margin-bottom: 8px; font-weight: 500;">Modelo:</label>
                        <select id="modelSelection" style="width: 100%; max-width: 600px; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                            <option value="none">Selecione um modelo...</option>
                            <option value="pantropicalModel">Modelo Pantropical (Chave et al., 2014)</option>
                            <option value="chambers2001">Modelo Chambers et al. (2001) - Amaz√¥nia Central</option>
                            <option value="ziemmer2016">Modelo Ziemmer et al. (2016) - Xaxins</option>
                            <option value="trautenmuller2021">Modelo Trautenm√ºller et al. (2021) - FOM</option>
                        </select>
                    </div>

                    <div id="modelDescription" style="background: rgba(76, 175, 80, 0.05); padding: 20px; border-radius: var(--border-radius); border: 1px solid var(--border-color); margin-top: 15px; line-height: 1.8;">
                        Selecione um modelo para ver sua descri√ß√£o.
                    </div>

                    <!-- Op√ß√£o para lidar com √°rvores sem altura -->
                    <div id="heightMissingOptions" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255, 160, 0, 0.05); border: 1px solid var(--warning-color); border-radius: var(--border-radius);">
                        <h4 style="margin: 0 0 10px 0; color: var(--warning-color);">‚ö†Ô∏è Tratamento de √Årvores sem Altura</h4>
                        <p style="margin: 0 0 10px 0; font-size: 13px; color: var(--text-color);">
                            O modelo selecionado requer altura, mas algumas √°rvores n√£o possuem essa medi√ß√£o.
                        </p>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Como proceder?</label>
                        <select id="missingHeightStrategy" style="width: 100%; padding: 8px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                            <option value="exclude">Excluir √°rvores sem altura do c√°lculo</option>
                            <option value="useMean">Usar altura m√©dia das √°rvores com altura medida</option>
                        </select>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: var(--text-light);">
                            <strong>Recomenda√ß√£o:</strong> Excluir √© mais conservador. Usar m√©dia √© aceit√°vel quando h√° poucas √°rvores sem altura e a floresta √© homog√™nea.
                        </p>
                    </div>
                </div>

                <!-- C√°lculo e Resultados -->
                <div style="margin-bottom: 30px;">
                    <h3 class="section-title" style="font-size: 18px;">2. C√°lculo da Biomassa</h3>

                    <button class="btn btn-primary" id="executeBiomass" onclick="executeBiomassCalculation()">
                        üßÆ Calcular Biomassa
                    </button>

                    <div id="biomassResults" style="display: none; margin-top: 20px;">
                        <div class="summary-card" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%);">
                            <h3 style="color: var(--primary-color); margin-bottom: 15px;">üìä Relat√≥rio de Biomassa</h3>
                            <div id="biomassReport" style="font-size: 16px; line-height: 1.8;"></div>
                        </div>

                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-primary" onclick="exportBiomassData()" style="font-size: 16px; padding: 12px 30px;">
                                üì• Baixar CSV com Dados de Biomassa
                            </button>
                            <p style="margin-top: 10px; font-size: 13px; color: var(--text-light);">
                                O arquivo incluir√° todas as √°rvores com seus valores de biomassa calculados
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="noDataMessage">
            <div class="icon">üå≤üìä</div>
            <h2>Nenhum dado carregado</h2>
            <p>Configure o tamanho da parcela e fa√ßa upload de um arquivo CSV do Planilha Florestal App para come√ßar a an√°lise</p>
            <div style="margin-top: 15px; font-size: 14px; color: var(--text-light);">
                üí° Exporte seus dados do app de coleta em formato CSV e importe aqui
            </div>
        </div>
    </div>

    <!-- Rodap√© -->
    <footer style="background: var(--background-color);
                  border-top: 1px solid var(--border-color);
                  padding: 20px 0;
                  margin-top: 40px;
                  text-align: center;">
        <div style="max-width: 1400px; margin: 0 auto; padding: 0 20px;">
            <div style="display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">üå≤</span>
                    <strong style="color: var(--primary-color);">Planilha Florestal</strong>
                    <span style="color: var(--text-light);">‚Ä¢ Sistema de Invent√°rio</span>
                </div>
                <div style="color: var(--text-light); font-size: 14px;">
                    <strong>Coleta:</strong> App PWA ‚Ä¢ <strong>An√°lise:</strong> Analytics (Em Testes)
                </div>
            </div>
            <div style="font-size: 12px; color: var(--text-light); line-height: 1.4;">
                Desenvolvido por <strong>Pedro Higuchi</strong> ‚Ä¢
                Ideal para engenheiros florestais, t√©cnicos e pesquisadores ‚Ä¢
                <span style="color: var(--warning-color); font-weight: bold;">üóã EM TESTES</span> - Use por sua conta e risco
            </div>
            <div style="margin-top: 10px; font-size: 11px; color: var(--text-light); opacity: 0.8;">
                Para suporte: higuchip@gmail.com ‚Ä¢
                <a href="https://github.com/higuchip/inventario_app" style="color: var(--primary-color); text-decoration: none;">GitHub</a>
            </div>
        </div>
    </footer>

    <script>
        // Vari√°veis globais
        let data = [];
        let originalData = [];
        let speciesCorrections = {};
        let processedData = {};
        let plotSizeM2 = 400; // Tamanho padr√£o da parcela em m¬≤
        let plotSizeConfigured = false;
        
        // Configura√ß√£o do tamanho da parcela
        const plotSizeInput = document.getElementById('plotSize');
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const stepUpload = document.getElementById('stepUpload');
        
        // Fun√ß√£o para habilitar upload
        function enableUpload() {
            plotSizeConfigured = true;
            stepUpload.style.opacity = '1';
            stepUpload.style.pointerEvents = 'auto';
            fileInput.disabled = false;
            uploadArea.style.borderColor = 'var(--primary-light)';
            
            // Mostrar status de configura√ß√£o
            const configStatus = document.getElementById('configStatus');
            const configStatusText = document.getElementById('configStatusText');
            configStatus.style.display = 'block';
            configStatusText.textContent = `Parcelas de ${plotSizeM2} m¬≤`;
            
            // Atualizar cor do n√∫mero do passo 2
            const step2Number = stepUpload.querySelector('span');
            step2Number.style.background = 'var(--primary-color)';
            const step2Title = stepUpload.querySelector('h2');
            step2Title.style.color = 'var(--primary-dark)';
        }
        
        // Event listener para mudan√ßa no tamanho da parcela
        plotSizeInput.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (!isNaN(value) && value > 0) {
                plotSizeM2 = value;
                enableUpload();

                // Se j√° houver dados carregados, reprocessar
                if (data.length > 0) {
                    processData();
                    showResults();
                }
            } else if (this.value === '') {
                // Allow empty field during typing
                return;
            } else {
                // Invalid input - reset to default
                this.value = plotSizeM2;
                alert('Por favor, insira um valor v√°lido maior que zero');
            }
        });
        
        // Valida√ß√£o inicial ao carregar a p√°gina
        plotSizeInput.addEventListener('change', function() {
            if (!this.value || parseFloat(this.value) <= 0) {
                this.value = 400;
                plotSizeM2 = 400;
            }
            enableUpload();
        });
        
        // Bot√µes de preset de tamanho
        document.querySelectorAll('.size-preset').forEach(button => {
            button.addEventListener('click', function() {
                const size = parseFloat(this.dataset.size);
                plotSizeInput.value = size;
                plotSizeM2 = size;
                
                // Atualizar visual dos bot√µes
                document.querySelectorAll('.size-preset').forEach(btn => {
                    btn.style.background = 'var(--background-color)';
                    btn.style.color = 'var(--text-color)';
                    btn.style.border = '1px solid var(--border-color)';
                });
                this.style.background = 'var(--primary-light)';
                this.style.color = 'white';
                this.style.border = '1px solid var(--primary-color)';
                
                enableUpload();
                
                // Se j√° houver dados, reprocessar
                if (data.length > 0) {
                    processData();
                    showResults();
                }
            });
        });
        
        // Configura√ß√£o do upload - s√≥ funciona se √°rea estiver configurada
        uploadArea.addEventListener('click', () => {
            if (plotSizeConfigured) {
                fileInput.click();
            } else {
                alert('Por favor, configure o tamanho da parcela primeiro (Passo 1)');
                plotSizeInput.focus();
            }
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (plotSizeConfigured) {
                uploadArea.classList.add('dragover');
            }
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (!plotSizeConfigured) {
                alert('Por favor, configure o tamanho da parcela primeiro (Passo 1)');
                plotSizeInput.focus();
                return;
            }
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0 && plotSizeConfigured) {
                processFile(e.target.files[0]);
            }
        });
        
        // Inicializar com valor padr√£o
        window.addEventListener('DOMContentLoaded', () => {
            // For√ßar valida√ß√£o inicial
            if (plotSizeInput.value && parseFloat(plotSizeInput.value) > 0) {
                plotSizeM2 = parseFloat(plotSizeInput.value);
                enableUpload();
            }
        });
        
        // Atualizar informa√ß√µes da √°rea
        function updateAreaInfo() {
            const areaInfoDiv = document.getElementById('areaInfo');
            const areaInfoContent = document.getElementById('areaInfoContent');
            
            if (data.length > 0) {
                const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
                const nParcelas = parcelas.length;
                const areaTotalM2 = nParcelas * plotSizeM2;
                const areaTotalHa = areaTotalM2 / 10000;
                
                areaInfoDiv.style.display = 'block';
                areaInfoContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong style="color: var(--text-light);">Tamanho da parcela:</strong><br>
                            <span style="font-size: 18px; color: var(--primary-dark);">${plotSizeM2} m¬≤</span>
                        </div>
                        <div>
                            <strong style="color: var(--text-light);">N¬∞ de parcelas:</strong><br>
                            <span style="font-size: 18px; color: var(--primary-dark);">${nParcelas}</span>
                        </div>
                        <div>
                            <strong style="color: var(--text-light);">√Årea total amostrada:</strong><br>
                            <span style="font-size: 18px; color: var(--primary-dark);">${areaTotalM2.toLocaleString('pt-BR')} m¬≤</span>
                            <small style="color: var(--text-light);"> (${areaTotalHa.toFixed(2)} ha)</small>
                        </div>
                    </div>
                `;
            } else {
                areaInfoDiv.style.display = 'none';
            }
        }
        

        
        // Processar arquivo CSV
        function processFile(file) {
            Papa.parse(file, {
                header: true,
                delimiter: ';',
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        if (!results.data || results.data.length === 0) {
                            alert('Erro: O arquivo CSV est√° vazio ou tem formato inv√°lido');
                            return;
                        }

                        // Validate required columns
                        const requiredColumns = ['Parcela', 'ID √Årvore', 'Esp√©cie', 'CAP'];
                        const firstRow = results.data[0];
                        const missingColumns = requiredColumns.filter(col => !(col in firstRow));

                        if (missingColumns.length > 0) {
                            alert(`Erro: Colunas obrigat√≥rias n√£o encontradas: ${missingColumns.join(', ')}`);
                            return;
                        }

                        data = results.data;
                        originalData = JSON.parse(JSON.stringify(results.data));
                        speciesCorrections = {};
                        prepareData();
                        updateAreaInfo(); // Atualizar info da √°rea ap√≥s preparar dados
                        showValidation();
                    } catch (error) {
                        alert('Erro ao processar arquivo: ' + error.message);
                        console.error('Erro detalhado:', error);
                    }
                },
                error: function(error) {
                    alert('Erro ao ler o arquivo CSV: ' + error.message);
                    console.error('Erro de parsing:', error);
                }
            });
        }

        // Preparar dados ap√≥s carregar
        function prepareData() {
            data = data.map(row => {
                // Validate and parse numeric values with better error handling
                let capValue = 0;
                if (row['CAP']) {
                    const capParsed = parseFloat(row['CAP'].toString().replace(',', '.'));
                    if (!isNaN(capParsed) && capParsed > 0 && capParsed < 10000) {
                        capValue = capParsed;
                    }
                }

                let alturaValue = null;
                if (row['Altura']) {
                    const alturaParsed = parseFloat(row['Altura'].toString().replace(',', '.'));
                    if (!isNaN(alturaParsed) && alturaParsed > 0 && alturaParsed < 200) {
                        alturaValue = alturaParsed;
                    }
                }

                return {
                    parcela: (row['Parcela'] || '').toString().trim(),
                    idArvore: row['ID √Årvore'] || '',
                    especie: row['Esp√©cie'] || '',
                    cap: capValue,
                    altura: alturaValue,
                    latitude: parseFloat(row['Latitude']?.replace(',', '.')) || null,
                    longitude: parseFloat(row['Longitude']?.replace(',', '.')) || null,
                    troncoMultiplo: row['Tronco M√∫ltiplo'] === 'Sim',
                    capsIndividuais: row['CAPs Individuais'] || ''
                };
            }).filter(row => {
                // Filter out invalid rows
                if (!row.parcela || row.parcela === '') {
                    console.warn('Row removed: missing parcela', row);
                    return false;
                }
                if (!row.especie || row.especie.trim() === '') {
                    console.warn('Row removed: missing species', row);
                    return false;
                }
                if (row.cap <= 0) {
                    console.warn('Row removed: invalid CAP value', row);
                    return false;
                }
                return true;
            });

            if (data.length === 0) {
                alert('Erro: Nenhum dado v√°lido encontrado no arquivo');
                return;
            }

            // Calculate derived values with validation
            data.forEach(row => {
                if (row.cap > 0) {
                    row.dap = row.cap / Math.PI;
                    row.areaBasal = (Math.PI * Math.pow(row.dap, 2)) / 40000;
                } else {
                    row.dap = 0;
                    row.areaBasal = 0;
                }
            });
        }

        // Mostrar valida√ß√£o
        function showValidation() {
            document.getElementById('noDataMessage').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[data-tab="validation"]').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('validation').classList.add('active');

            populateSpeciesTable();
        }

        // Preencher tabela de esp√©cies para valida√ß√£o
        function populateSpeciesTable() {
            const speciesCount = {};
            data.forEach(row => {
                speciesCount[row.especie] = (speciesCount[row.especie] || 0) + 1;
            });

            const tbody = document.getElementById('speciesTableBody');
            tbody.innerHTML = '';

            Object.entries(speciesCount)
                .sort((a, b) => b[1] - a[1])
                .forEach(([species, count]) => {
                    const tr = document.createElement('tr');
                    // Escape user input to prevent XSS but maintain original functionality
                    const escapedSpecies = species.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    const escapedSpeciesAttr = species.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    tr.innerHTML = `
                        <td style="text-align: center;">
                            <input type="checkbox" class="species-checkbox" value="${escapedSpeciesAttr}"
                                   style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td>${escapedSpecies}</td>
                        <td style="text-align: center;">${count}</td>
                        <td>
                            <input type="text"
                                   class="species-correction"
                                   data-original="${escapedSpeciesAttr}"
                                   placeholder="Deixe vazio se correto"
                                   value="${speciesCorrections[escapedSpeciesAttr] || ''}"
                                   style="width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px;">
                        </td>
                        <td style="text-align: center;">
                            <button onclick="quickCorrect('${escapedSpeciesAttr}')"
                                    class="btn btn-secondary"
                                    style="padding: 6px 12px; font-size: 12px;">
                                ‚úì Aplicar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

            document.getElementById('searchSpecies').addEventListener('input', filterSpeciesTable);
        }

        // Filtrar tabela de esp√©cies
        function filterSpeciesTable() {
            const searchTerm = document.getElementById('searchSpecies').value.toLowerCase();
            const rows = document.getElementById('speciesTableBody').querySelectorAll('tr');

            rows.forEach(row => {
                const speciesName = row.cells[1].textContent.toLowerCase();
                row.style.display = speciesName.includes(searchTerm) ? '' : 'none';
            });
        }

        // Ordenar esp√©cies alfabeticamente
        function sortSpeciesAlpha() {
            const tbody = document.getElementById('speciesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                return a.cells[1].textContent.localeCompare(b.cells[1].textContent);
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Ordenar esp√©cies por quantidade
        function sortSpeciesCount() {
            const tbody = document.getElementById('speciesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const countA = parseInt(a.cells[2].textContent);
                const countB = parseInt(b.cells[2].textContent);
                return countB - countA;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Corre√ß√£o r√°pida de esp√©cie
        function quickCorrect(originalSpecies) {
            const input = document.querySelector(`input.species-correction[data-original="${originalSpecies}"]`);
            const correctedName = input.value.trim();

            if (correctedName && correctedName !== originalSpecies) {
                speciesCorrections[originalSpecies] = correctedName;

                data.forEach(row => {
                    if (row.especie === originalSpecies) {
                        row.especie = correctedName;
                    }
                });

                populateSpeciesTable();
                showCorrectionStatus(`‚úì "${originalSpecies}" corrigido para "${correctedName}"`);
            }
        }

        // Aplicar todas as corre√ß√µes de esp√©cies
        function applySpeciesCorrections() {
            const inputs = document.querySelectorAll('.species-correction');
            let correctionCount = 0;

            inputs.forEach(input => {
                const original = input.dataset.original;
                const corrected = input.value.trim();

                if (corrected && corrected !== original) {
                    speciesCorrections[original] = corrected;
                    correctionCount++;

                    data.forEach(row => {
                        if (row.especie === original) {
                            row.especie = corrected;
                        }
                    });
                }
            });

            if (correctionCount > 0) {
                populateSpeciesTable();
                showCorrectionStatus(`‚úì ${correctionCount} corre√ß√£o(√µes) aplicada(s) com sucesso`);
            } else {
                showCorrectionStatus('‚ö†Ô∏è Nenhuma corre√ß√£o para aplicar', 'warning');
            }
        }

        // Mesclar esp√©cies selecionadas
        function mergeSelectedSpecies() {
            const checkboxes = document.querySelectorAll('.species-checkbox:checked');

            if (checkboxes.length < 2) {
                alert('Selecione pelo menos 2 esp√©cies para mesclar');
                return;
            }

            const selectedSpecies = Array.from(checkboxes).map(cb => cb.value);
            const targetName = prompt(
                `Mesclar ${selectedSpecies.length} esp√©cies selecionadas.\n\n` +
                `Esp√©cies: ${selectedSpecies.join(', ')}\n\n` +
                'Digite o nome correto para a esp√©cie:',
                selectedSpecies[0]
            );

            if (targetName && targetName.trim()) {
                const finalName = targetName.trim();

                selectedSpecies.forEach(species => {
                    speciesCorrections[species] = finalName;

                    data.forEach(row => {
                        if (row.especie === species) {
                            row.especie = finalName;
                        }
                    });
                });

                populateSpeciesTable();
                showCorrectionStatus(`‚úì ${selectedSpecies.length} esp√©cies mescladas em "${finalName}"`);

                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        // Exportar lista de esp√©cies
        function exportSpeciesList() {
            const speciesCount = {};
            data.forEach(row => {
                speciesCount[row.especie] = (speciesCount[row.especie] || 0) + 1;
            });

            let csv = '\ufeff';
            csv += 'Esp√©cie;N¬∞ Indiv√≠duos\n';

            Object.entries(speciesCount)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([species, count]) => {
                    csv += `${species};${count}\n`;
                });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);

            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
            link.download = `lista_especies_${dateStr}.csv`;
            link.click();
        }

        // Exportar CSV corrigido
        function exportCorrectedCSV() {
            if (!data || data.length === 0) {
                alert('N√£o h√° dados para exportar');
                return;
            }

            let csv = '\ufeff'; // BOM para UTF-8

            // Cabe√ßalho baseado na estrutura original
            csv += 'Parcela;ID √Årvore;Esp√©cie;CAP;Altura;Latitude;Longitude;Tronco M√∫ltiplo;CAPs Individuais\n';

            // Dados corrigidos
            data.forEach(row => {
                const linha = [
                    row.parcela || '',
                    row.idArvore || '',
                    row.especie || '',
                    row.cap ? row.cap.toFixed(1).replace('.', ',') : '',
                    row.altura ? row.altura.toFixed(1).replace('.', ',') : '',
                    row.latitude ? row.latitude.toFixed(6).replace('.', ',') : '',
                    row.longitude ? row.longitude.toFixed(6).replace('.', ',') : '',
                    row.troncoMultiplo ? 'Sim' : 'N√£o',
                    row.capsIndividuais || ''
                ];

                // Escape aspas duplas e envolver campos que cont√™m ponto e v√≠rgula
                const linhaEscapada = linha.map(campo => {
                    const campoStr = campo.toString();
                    if (campoStr.includes(';') || campoStr.includes('"') || campoStr.includes('\n')) {
                        return '"' + campoStr.replace(/"/g, '""') + '"';
                    }
                    return campoStr;
                });

                csv += linhaEscapada.join(';') + '\n';
            });

            // Adicionar informa√ß√µes sobre as corre√ß√µes feitas
            let hasCorrections = false;

            if (Object.keys(speciesCorrections).length > 0) {
                csv += '\n\n;CORRE√á√ïES DE ESP√âCIES APLICADAS:\n';
                Object.entries(speciesCorrections).forEach(([original, corrected]) => {
                    csv += `;${original} ‚Üí ${corrected}\n`;
                });
                hasCorrections = true;
            }

            // Contar outliers que foram editados ou removidos
            const originalDataLength = originalData.length;
            const currentDataLength = data.length;
            const removedOutliers = originalDataLength - currentDataLength;

            // Contar registros editados (comparando com dados originais)
            let editedRecords = 0;
            if (originalData && originalData.length > 0) {
                data.forEach((currentRow, index) => {
                    if (originalData[index]) {
                        const origCAP = parseFloat(originalData[index]['CAP']?.replace(',', '.')) || 0;
                        const origAltura = parseFloat(originalData[index]['Altura']?.replace(',', '.')) || null;

                        if (Math.abs(currentRow.cap - origCAP) > 0.1 ||
                            (origAltura && currentRow.altura && Math.abs(currentRow.altura - origAltura) > 0.1)) {
                            editedRecords++;
                        }
                    }
                });
            }

            if (removedOutliers > 0 || editedRecords > 0) {
                if (hasCorrections) csv += '\n';
                csv += ';CORRE√á√ïES DE OUTLIERS:\n';
                if (removedOutliers > 0) {
                    csv += `;√Årvores removidas: ${removedOutliers}\n`;
                }
                if (editedRecords > 0) {
                    csv += `;Registros editados: ${editedRecords}\n`;
                }
                hasCorrections = true;
            }

            if (hasCorrections) {
                csv += `\n;Total de registros finais: ${data.length}\n`;
                csv += `;Data da valida√ß√£o: ${new Date().toLocaleString('pt-BR')}\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);

            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
            const timeStr = `${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            link.download = `dados_florestais_corrigidos_${dateStr}_${timeStr}.csv`;

            link.click();

            showCorrectionStatus(`‚úì CSV corrigido exportado com ${data.length} registros`);
        }

        // Mostrar status de corre√ß√£o
        function showCorrectionStatus(message, type = 'success') {
            const statusDiv = document.getElementById('correctionStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = type === 'success' ?
                'rgba(76, 175, 80, 0.1)' :
                'rgba(255, 160, 0, 0.1)';
            statusDiv.style.borderLeft = type === 'success' ?
                '4px solid var(--primary-color)' :
                '4px solid var(--warning-color)';
            statusDiv.textContent = message;

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Detectar outliers
        function detectOutliers() {
            const method = document.getElementById('outlierMethod').value;
            const tbody = document.getElementById('outliersTableBody');
            tbody.innerHTML = '';

            const outliers = [];

            const dapValues = data.map(d => d.dap).filter(v => v > 0);
            const dapOutliers = method === 'iqr' ?
                detectOutliersIQR(dapValues) :
                detectOutliersZScore(dapValues);

            const alturaValues = data.map(d => d.altura).filter(v => v && v > 0);
            const alturaOutliers = alturaValues.length > 0 ?
                (method === 'iqr' ? detectOutliersIQR(alturaValues) : detectOutliersZScore(alturaValues)) :
                { lower: null, upper: null };

            data.forEach((row, index) => {
                let isOutlier = false;
                let outlierType = [];

                if (row.dap < dapOutliers.lower || row.dap > dapOutliers.upper) {
                    isOutlier = true;
                    outlierType.push('DAP');
                }

                if (row.altura && alturaOutliers.lower !== null &&
                    (row.altura < alturaOutliers.lower || row.altura > alturaOutliers.upper)) {
                    isOutlier = true;
                    outlierType.push('Altura');
                }

                if (isOutlier) {
                    outliers.push({
                        index: index,
                        row: row,
                        type: outlierType.join(', ')
                    });
                }
            });

            document.getElementById('outlierCount').textContent = outliers.length;

            // Atualizar informa√ß√µes adicionais
            const outlierInfo = document.getElementById('outlierInfo');
            if (outliers.length === 0) {
                outlierInfo.textContent = 'Todos os valores est√£o dentro do padr√£o normal';
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: var(--text-light);">‚úì Nenhum outlier detectado - dados est√£o consistentes</td></tr>';
            } else {
                const dapOutliers = outliers.filter(o => o.type.includes('DAP')).length;
                const alturaOutliers = outliers.filter(o => o.type.includes('Altura')).length;
                outlierInfo.innerHTML = `${dapOutliers} outliers de DAP, ${alturaOutliers} outliers de altura`;

                tbody.innerHTML = ''; // Limpar antes de adicionar novos outliers
                outliers.forEach(outlier => {
                    const row = outlier.row;
                    const tr = document.createElement('tr');
                    tr.style.background = 'rgba(255, 160, 0, 0.1)';
                    // Escape user input to prevent XSS
                    const escapedParcela = (row.parcela || '').toString().replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const escapedEspecie = (row.especie || '').toString().replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    tr.innerHTML = `
                        <td>${escapedParcela}</td>
                        <td>${row.idArvore}</td>
                        <td>${escapedEspecie}</td>
                        <td>${row.cap.toFixed(1)}</td>
                        <td style="font-weight: ${outlier.type.includes('DAP') ? 'bold' : 'normal'}; color: ${outlier.type.includes('DAP') ? 'var(--warning-color)' : 'inherit'};">
                            ${row.dap.toFixed(1)}
                        </td>
                        <td style="font-weight: ${outlier.type.includes('Altura') ? 'bold' : 'normal'}; color: ${outlier.type.includes('Altura') ? 'var(--warning-color)' : 'inherit'};">
                            ${row.altura ? row.altura.toFixed(1) : '-'}
                        </td>
                        <td><strong style="color: var(--warning-color);">${outlier.type}</strong></td>
                        <td style="text-align: center;">
                            <button onclick="editOutlierValues(${outlier.index})" class="btn btn-secondary"
                                    style="padding: 6px 12px; font-size: 12px; margin-right: 8px;"
                                    title="Corrigir valores de medi√ß√£o">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="removeOutlier(${outlier.index})" class="btn btn-secondary"
                                    style="padding: 6px 12px; font-size: 12px; background: var(--error-color);"
                                    title="Remover √°rvore do banco de dados">
                                üóëÔ∏è Remover
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // Detectar outliers usando IQR
        function detectOutliersIQR(values) {
            const sorted = [...values].sort((a, b) => a - b);
            const q1Index = Math.floor(sorted.length * 0.25);
            const q3Index = Math.floor(sorted.length * 0.75);

            const q1 = sorted[q1Index];
            const q3 = sorted[q3Index];
            const iqr = q3 - q1;

            return {
                lower: q1 - 1.5 * iqr,
                upper: q3 + 1.5 * iqr
            };
        }

        // Detectar outliers usando Z-Score
        function detectOutliersZScore(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const std = Math.sqrt(values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length);

            return {
                lower: mean - 3 * std,
                upper: mean + 3 * std
            };
        }

        // Nova fun√ß√£o para editar valores de outlier com mais op√ß√µes
        function editOutlierValues(index) {
            const row = data[index];

            // Interface mais amig√°vel para edi√ß√£o
            const editModal = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 500px; margin: 20px auto;">
                    <h3 style="margin-top: 0; color: var(--primary-color);">‚úèÔ∏è Editar Valores - Outlier</h3>

                    <div style="background: var(--background-color); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <strong>√Årvore:</strong> ${row.parcela} - ID ${row.idArvore}<br>
                        <strong>Esp√©cie:</strong> ${row.especie}
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">CAP (cm):</label>
                        <input type="number" id="editCAP" value="${row.cap.toFixed(1)}"
                               style="width: 100%; padding: 8px; border: 2px solid var(--border-color); border-radius: 4px;"
                               min="0" step="0.1">
                        <small style="color: var(--text-light);">DAP ser√° calculado automaticamente (DAP = CAP √∑ œÄ)</small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Altura (m):</label>
                        <input type="number" id="editAltura" value="${row.altura ? row.altura.toFixed(1) : ''}"
                               style="width: 100%; padding: 8px; border: 2px solid var(--border-color); border-radius: 4px;"
                               min="0" step="0.1" placeholder="Deixe vazio se n√£o medido">
                    </div>

                    <div style="text-align: right;">
                        <button onclick="cancelEdit()" style="padding: 8px 16px; margin-right: 10px; background: var(--border-color); border: none; border-radius: 4px; cursor: pointer;">
                            Cancelar
                        </button>
                        <button onclick="saveEdit(${index})" style="padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ‚úì Salvar
                        </button>
                    </div>
                </div>
            `;

            // Criar overlay modal
            const overlay = document.createElement('div');
            overlay.id = 'editOverlay';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            overlay.innerHTML = editModal;
            document.body.appendChild(overlay);
        }

        // Salvar edi√ß√£o
        function saveEdit(index) {
            const capInput = document.getElementById('editCAP');
            const alturaInput = document.getElementById('editAltura');

            const newCAP = parseFloat(capInput.value);
            const newAltura = alturaInput.value ? parseFloat(alturaInput.value) : null;

            if (newCAP && newCAP > 0) {
                data[index].cap = newCAP;
                data[index].dap = newCAP / Math.PI;
                data[index].areaBasal = (Math.PI * Math.pow(data[index].dap, 2)) / 40000;

                if (newAltura && newAltura > 0) {
                    data[index].altura = newAltura;
                } else if (alturaInput.value === '') {
                    data[index].altura = null;
                }

                cancelEdit();
                detectOutliers();
                showCorrectionStatus('‚úì Valores editados com sucesso');
            } else {
                alert('Por favor, insira um valor v√°lido para CAP');
            }
        }

        // Cancelar edi√ß√£o
        function cancelEdit() {
            const overlay = document.getElementById('editOverlay');
            if (overlay) {
                overlay.remove();
            }
        }


        // Remover outlier
        function removeOutlier(index) {
            const row = data[index];
            if (confirm(
                `Remover registro?\n\n` +
                `Parcela: ${row.parcela}\n` +
                `ID √Årvore: ${row.idArvore}\n` +
                `Esp√©cie: ${row.especie}\n` +
                `DAP: ${row.dap.toFixed(1)} cm`
            )) {
                data.splice(index, 1);
                detectOutliers();
                showCorrectionStatus('‚úì Registro removido');
            }
        }

        // Prosseguir para an√°lises
        function proceedToAnalysis() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab[data-tab="summary"]').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('summary').classList.add('active');

            // N√£o reprocessar os dados, apenas calcular novamente com os dados corrigidos
            calculateAnalysis();
            showResults();
        }

        // Fun√ß√£o separada para calcular apenas as an√°lises sem reprocessar dados
        function calculateAnalysis() {
            // Recalcular valores derivados se necess√°rio
            data.forEach(row => {
                if (row.cap > 0) {
                    row.dap = row.cap / Math.PI;
                    row.areaBasal = (Math.PI * Math.pow(row.dap, 2)) / 40000;
                }
            });

            // Log para debug
            console.log('Dados ap√≥s valida√ß√£o:', data.length, '√°rvores');
            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            console.log('Parcelas:', parcelas.length);
            const areaBasalTotal = data.reduce((sum, d) => sum + d.areaBasal, 0);
            console.log('√Årea basal total:', areaBasalTotal.toFixed(4), 'm¬≤');
            const areaTotalHa = (parcelas.length * plotSizeM2) / 10000;
            console.log('√Årea total:', areaTotalHa.toFixed(2), 'ha');
            console.log('√Årea basal/ha:', (areaBasalTotal/areaTotalHa).toFixed(2), 'm¬≤/ha');

            // Processar dados fitossociol√≥gicos
            calculatePhytosociology();
            calculateDiversity();
            calculateAccumulationCurve();
            calculateSpatialPattern();
        }
        
        // Processar dados (apenas quando necess√°rio - evita sobrescrever dados validados)
        function processData() {
            // Se os dados j√° foram processados e validados, use calculateAnalysis() ao inv√©s desta fun√ß√£o
            if (data.length > 0 && data[0].hasOwnProperty('dap')) {
                // Dados j√° foram processados, apenas recalcular an√°lises
                calculateAnalysis();
                return;
            }

            // Limpar e preparar dados (primeira vez)
            data = data.map(row => ({
                parcela: row['Parcela'],
                idArvore: row['ID √Årvore'],
                especie: row['Esp√©cie'],
                cap: parseFloat(row['CAP']?.replace(',', '.')) || 0,
                altura: parseFloat(row['Altura']?.replace(',', '.')) || null,
                latitude: parseFloat(row['Latitude']?.replace(',', '.')) || null,
                longitude: parseFloat(row['Longitude']?.replace(',', '.')) || null,
                troncoMultiplo: row['Tronco M√∫ltiplo'] === 'Sim',
                capsIndividuais: row['CAPs Individuais'] || ''
            })).filter(row => row.especie && row.cap > 0);

            // Calcular DAP a partir do CAP e √°rea basal
            data.forEach(row => {
                // Para troncos m√∫ltiplos, o CAP j√° vem calculado como equivalente
                row.dap = row.cap / Math.PI; // DAP em cm
                // √Årea basal: (œÄ * DAP¬≤) / 40000
                // DAP em cm, resultado em m¬≤
                row.areaBasal = (Math.PI * Math.pow(row.dap, 2)) / 40000; // em m¬≤
            });

            // Log para debug
            console.log('Dados processados:', data.length, '√°rvores');
            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            console.log('Parcelas:', parcelas.length);
            const areaBasalTotal = data.reduce((sum, d) => sum + d.areaBasal, 0);
            console.log('√Årea basal total:', areaBasalTotal.toFixed(4), 'm¬≤');
            const areaTotalHa = (parcelas.length * plotSizeM2) / 10000;
            console.log('√Årea total:', areaTotalHa.toFixed(2), 'ha');
            console.log('√Årea basal/ha:', (areaBasalTotal/areaTotalHa).toFixed(2), 'm¬≤/ha');

            // Processar dados fitossociol√≥gicos
            calculatePhytosociology();
            calculateDiversity();
            calculateAccumulationCurve();
            calculateSpatialPattern();
        }
        
        // Calcular par√¢metros fitossociol√≥gicos
        function calculatePhytosociology() {
            const species = {};
            const totalIndividuals = data.length;
            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            const totalParcelas = parcelas.length;
            const totalBasalArea = data.reduce((sum, d) => sum + d.areaBasal, 0);
            
            // Usar o tamanho da parcela definido pelo usu√°rio
            const areaTotalha = (totalParcelas * plotSizeM2) / 10000; // convers√£o para hectares
            
            // Agrupar por esp√©cie
            data.forEach(row => {
                if (!species[row.especie]) {
                    species[row.especie] = {
                        name: row.especie,
                        individuals: [],
                        parcelas: new Set(),
                        totalBasalArea: 0
                    };
                }
                species[row.especie].individuals.push(row);
                species[row.especie].parcelas.add(row.parcela);
                species[row.especie].totalBasalArea += row.areaBasal;
            });
            
            // Soma das frequ√™ncias absolutas para c√°lculo de FR
            const totalFA = Object.values(species).reduce((sum, sp) => 
                sum + sp.parcelas.size, 0
            );
            
            // Calcular par√¢metros
            processedData.phytosociology = Object.values(species).map(sp => {
                const n = sp.individuals.length;
                const fa = sp.parcelas.size;
                const g = sp.totalBasalArea;
                
                // Densidade
                const da = n / areaTotalha; // Densidade absoluta (ind/ha)
                const dr = (n / totalIndividuals) * 100; // Densidade relativa (%)
                
                // Frequ√™ncia
                const faa = (fa / totalParcelas) * 100; // Frequ√™ncia absoluta (%)
                const fr = (fa / totalFA) * 100; // Frequ√™ncia relativa (%)
                
                // Domin√¢ncia
                const doa = g / areaTotalha; // Domin√¢ncia absoluta (m¬≤/ha)
                const dor = (g / totalBasalArea) * 100; // Domin√¢ncia relativa (%)
                
                // IVI - Valor de Import√¢ncia (m√©dia dos tr√™s par√¢metros relativos)
                const ivi = (dr + dor + fr) / 3;
                
                return {
                    especie: sp.name,
                    n: n,
                    da: da,
                    dr: dr,
                    fa: faa,
                    fr: fr,
                    doa: doa,
                    dor: dor,
                    ivi: ivi
                };
            }).sort((a, b) => b.ivi - a.ivi);
        }
        
        // Calcular √≠ndices de diversidade
        function calculateDiversity() {
            const speciesCount = {};
            data.forEach(row => {
                speciesCount[row.especie] = (speciesCount[row.especie] || 0) + 1;
            });
            
            const N = data.length;
            const S = Object.keys(speciesCount).length;
            
            // Shannon
            let shannon = 0;
            Object.values(speciesCount).forEach(count => {
                const pi = count / N;
                if (pi > 0) {
                    shannon -= pi * Math.log(pi);
                }
            });
            
            // Pielou
            const pielou = shannon / Math.log(S);
            
            // Simpson
            let simpson = 0;
            Object.values(speciesCount).forEach(count => {
                const pi = count / N;
                simpson += pi * pi;
            });
            
            processedData.diversity = {
                shannon: shannon.toFixed(3),
                pielou: pielou.toFixed(3),
                richness: S,
                simpson: (1 - simpson).toFixed(3),
                totalIndividuals: N
            };
        }
        
        // Calcular curva de acumula√ß√£o com aleatoriza√ß√£o
        function calculateAccumulationCurve() {
            const iterations = 100; // N√∫mero de itera√ß√µes para aleatoriza√ß√£o
            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))].sort();
            const nParcelas = parcelas.length;
            
            // Criar matriz de presen√ßa/aus√™ncia (parcelas x esp√©cies)
            const speciesList = [...new Set(data.map(d => d.especie))];
            const presenceMatrix = {};
            
            parcelas.forEach(parcela => {
                presenceMatrix[parcela] = {};
                speciesList.forEach(especie => {
                    presenceMatrix[parcela][especie] = 0;
                });
            });
            
            // Preencher matriz de presen√ßa
            data.forEach(row => {
                if (presenceMatrix[row.parcela] && presenceMatrix[row.parcela][row.especie] !== undefined) {
                    presenceMatrix[row.parcela][row.especie] = 1;
                }
            });
            
            // Calcular curva de acumula√ß√£o com aleatoriza√ß√£o
            const accumulation = [];
            
            for (let sampleSize = 1; sampleSize <= nParcelas; sampleSize++) {
                const richnessValues = [];
                
                for (let iter = 0; iter < iterations; iter++) {
                    // Amostrar parcelas aleatoriamente
                    const sampledParcelas = shuffleArray([...parcelas]).slice(0, sampleSize);
                    
                    // Contar esp√©cies √∫nicas nas parcelas amostradas
                    const speciesFound = new Set();
                    sampledParcelas.forEach(parcela => {
                        speciesList.forEach(especie => {
                            if (presenceMatrix[parcela][especie] === 1) {
                                speciesFound.add(especie);
                            }
                        });
                    });
                    
                    richnessValues.push(speciesFound.size);
                }
                
                // Calcular m√©dia e desvio padr√£o
                const mean = richnessValues.reduce((a, b) => a + b, 0) / richnessValues.length;
                const std = Math.sqrt(richnessValues.reduce((sum, val) => 
                    sum + Math.pow(val - mean, 2), 0) / richnessValues.length);
                
                accumulation.push({
                    parcela: sampleSize,
                    species: mean,
                    std: std,
                    min: mean - 1.96 * std, // IC 95%
                    max: mean + 1.96 * std  // IC 95%
                });
            }
            
            processedData.accumulation = accumulation;
            
            // Calcular estimadores de riqueza
            calculateRichnessEstimators();
        }
        
        // Fun√ß√£o auxiliar para embaralhar array (Fisher-Yates)
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
        
        // Calcular estimadores de riqueza (Chao, Jackknife, Bootstrap)
        function calculateRichnessEstimators() {
            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            const especies = [...new Set(data.map(d => d.especie))];
            const N = parcelas.length; // N√∫mero de parcelas
            const S0 = especies.length; // Riqueza observada
            
            // Contar ocorr√™ncias de cada esp√©cie por parcela
            const speciesOccurrence = {};
            especies.forEach(esp => {
                speciesOccurrence[esp] = 0;
            });
            
            parcelas.forEach(parcela => {
                const especiesInParcela = [...new Set(data.filter(d => d.parcela === parcela).map(d => d.especie))];
                especiesInParcela.forEach(esp => {
                    speciesOccurrence[esp]++;
                });
            });
            
            // Contar singletons (a1) e doubletons (a2)
            let a1 = 0; // Esp√©cies que ocorrem em apenas uma parcela
            let a2 = 0; // Esp√©cies que ocorrem em duas parcelas
            
            Object.values(speciesOccurrence).forEach(count => {
                if (count === 1) a1++;
                if (count === 2) a2++;
            });
            
            // Calcular estimadores
            const estimators = {
                observed: S0,
                chao1: a2 > 0 ? S0 + (a1 * a1) / (2 * a2) * ((N - 1) / N) : S0 + a1,
                chao2BC: S0 + (a1 * (a1 - 1)) / (2 * (a2 + 1)) * ((N - 1) / N),
                jackknife1: S0 + a1 * ((N - 1) / N),
                jackknife2: N > 1 ? S0 + (a1 / 2) * ((N - 3) / N) - a2 * Math.pow(N - 2, 2) / (N * (N - 1)) : S0,
                bootstrap: 0,
                singletons: a1,
                doubletons: a2,
                nParcelas: N
            };
            
            // Bootstrap
            let bootstrapSum = 0;
            Object.values(speciesOccurrence).forEach(count => {
                const p = count / N;
                bootstrapSum += Math.pow(1 - p, N);
            });
            estimators.bootstrap = S0 + bootstrapSum;
            
            processedData.estimators = estimators;
        }
        
        // Calcular padr√£o espacial (√çndice de Morisita)
        function calculateSpatialPattern() {
            // Pegar as 5 esp√©cies mais abundantes
            const speciesCount = {};
            data.forEach(row => {
                speciesCount[row.especie] = (speciesCount[row.especie] || 0) + 1;
            });
            
            const topSpecies = Object.entries(speciesCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([species]) => species);

            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            const nplots = parcelas.length;
            
            processedData.morisita = topSpecies.map(species => {
                const speciesData = data.filter(d => d.especie === species);
                const ni = speciesData.length; // n√∫mero total de indiv√≠duos da esp√©cie
                
                // Criar tabela de conting√™ncia (parcelas x esp√©cie)
                const parcelaCounts = {};
                parcelas.forEach(p => {
                    parcelaCounts[p] = speciesData.filter(d => d.parcela === p).length;
                });
                
                // Calcular soma de xi¬≤ - ni (onde xi √© o n√∫mero de indiv√≠duos por parcela)
                let sumXiSquaredMinusNi = 0;
                Object.values(parcelaCounts).forEach(xi => {
                    sumXiSquaredMinusNi += (xi * xi) - xi;
                });
                
                // √çndice de Morisita: Id = nplots * (Œ£(xi¬≤) - Œ£xi) / (ni * (ni - 1))
                // Simplificado: Id = nplots * Œ£(xi¬≤ - xi) / (ni * (ni - 1))
                const morisita = ni > 1 ? 
                    (nplots * sumXiSquaredMinusNi) / (ni * (ni - 1)) : 0;
                
                // Calcular limites de agrega√ß√£o e uniformidade usando qui-quadrado
                // Para Œ± = 0.05
                const chiSquareUpper = getChiSquareValue(nplots - 1, 0.95); // 95% percentil
                const chiSquareLower = getChiSquareValue(nplots - 1, 0.05); // 5% percentil
                
                const limAgr = ni > 1 ? 
                    (chiSquareUpper - nplots + ni) / (ni - 1) : 0;
                const limUni = ni > 1 ? 
                    (chiSquareLower - nplots + ni) / (ni - 1) : 0;
                
                // Determinar padr√£o espacial
                let pattern = 'Aleat√≥rio';
                if (morisita > limAgr) {
                    pattern = 'Agregado';
                } else if (morisita < limUni) {
                    pattern = 'Uniforme';
                }
                
                return {
                    especie: species,
                    n: ni,
                    morisita: morisita.toFixed(3),
                    limAgr: limAgr.toFixed(3),
                    limUni: limUni.toFixed(3),
                    pattern: pattern
                };
            });
        }
        
        // Fun√ß√£o auxiliar para obter valores de qui-quadrado
        function getChiSquareValue(df, percentile) {
            // Aproxima√ß√£o usando tabela simplificada para valores comuns
            // Para uma implementa√ß√£o completa, seria necess√°rio usar uma biblioteca estat√≠stica
            const chiSquareTable = {
                1: {0.05: 0.004, 0.95: 3.841},
                2: {0.05: 0.103, 0.95: 5.991},
                3: {0.05: 0.352, 0.95: 7.815},
                4: {0.05: 0.711, 0.95: 9.488},
                5: {0.05: 1.145, 0.95: 11.070},
                6: {0.05: 1.635, 0.95: 12.592},
                7: {0.05: 2.167, 0.95: 14.067},
                8: {0.05: 2.733, 0.95: 15.507},
                9: {0.05: 3.325, 0.95: 16.919},
                10: {0.05: 3.940, 0.95: 18.307},
                15: {0.05: 7.261, 0.95: 24.996},
                20: {0.05: 10.851, 0.95: 31.410},
                30: {0.05: 18.493, 0.95: 43.773},
                50: {0.05: 34.764, 0.95: 67.505}
            };
            
            // Se o df exato n√£o estiver na tabela, interpolar ou usar o valor mais pr√≥ximo
            if (chiSquareTable[df]) {
                return chiSquareTable[df][percentile];
            }
            
            // Interpola√ß√£o linear para valores n√£o tabelados
            const dfs = Object.keys(chiSquareTable).map(Number).sort((a, b) => a - b);
            let lowerDf = 1, upperDf = 50;
            
            for (let i = 0; i < dfs.length - 1; i++) {
                if (dfs[i] <= df && dfs[i + 1] >= df) {
                    lowerDf = dfs[i];
                    upperDf = dfs[i + 1];
                    break;
                }
            }
            
            if (df > 50) return chiSquareTable[50][percentile];
            if (df < 1) return chiSquareTable[1][percentile];
            
            const lowerValue = chiSquareTable[lowerDf][percentile];
            const upperValue = chiSquareTable[upperDf][percentile];
            const ratio = (df - lowerDf) / (upperDf - lowerDf);
            
            return lowerValue + ratio * (upperValue - lowerValue);
        }
        
        // Mostrar resultados
        function showResults() {
            document.getElementById('noDataMessage').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Atualizar resumo
            updateSummary();
            
            // Criar tabela fitossociol√≥gica
            createPhytoTable();
            
            // Criar histogramas de estrutura
            createStructureHistograms();
            
            // Criar gr√°ficos
            createAccumulationChart();
            createDiversityChart();
            createSpatialChart();
            
            // Atualizar √≠ndices
            updateDiversityIndices();
        }
        
        // Fun√ß√£o para obter configura√ß√µes responsivas dos gr√°ficos
        function getResponsiveChartOptions() {
            const isMobile = window.innerWidth < 768;
            return {
                fontSize: isMobile ? 10 : 12,
                titleFontSize: isMobile ? 11 : 14,
                legendFontSize: isMobile ? 10 : 12,
                maxRotation: isMobile ? 45 : 0,
                padding: isMobile ? 10 : 15
            };
        }

        // Criar histogramas de estrutura (DAP e Altura)
        function createStructureHistograms() {
            // Dados de DAP
            const dapValues = data.map(d => d.dap).filter(v => v > 0);
            
            // Calcular n√∫mero de classes usando regra de Sturges
            const nClasses = Math.ceil(1 + 3.322 * Math.log10(dapValues.length));
            
            // Calcular amplitude e tamanho das classes
            const dapMin = Math.min(...dapValues);
            const dapMax = Math.max(...dapValues);
            const dapRange = dapMax - dapMin;
            const dapClassWidth = dapRange / nClasses;
            
            // Criar classes e calcular frequ√™ncias
            const dapClasses = [];
            const dapFrequencies = [];
            const dapDensities = [];
            
            for (let i = 0; i < nClasses; i++) {
                const lowerBound = dapMin + (i * dapClassWidth);
                const upperBound = lowerBound + dapClassWidth;
                const midPoint = (lowerBound + upperBound) / 2;
                
                const frequency = dapValues.filter(v => 
                    i === nClasses - 1 ? v >= lowerBound && v <= upperBound : v >= lowerBound && v < upperBound
                ).length;
                
                dapClasses.push(`${lowerBound.toFixed(1)}-${upperBound.toFixed(1)}`);
                dapFrequencies.push(frequency);
                // Densidade = frequ√™ncia / (n * amplitude da classe)
                dapDensities.push(frequency / (dapValues.length * dapClassWidth));
            }
            
            // Criar histograma de DAP
            const ctxDAP = document.getElementById('dapHistogram').getContext('2d');
            const responsiveOptions = getResponsiveChartOptions();

            new Chart(ctxDAP, {
                type: 'bar',
                data: {
                    labels: dapClasses,
                    datasets: [{
                        label: 'Frequ√™ncia',
                        data: dapFrequencies,
                        backgroundColor: 'rgba(46, 125, 50, 0.6)',
                        borderColor: 'rgb(46, 125, 50)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: 'Densidade',
                        data: dapDensities.map((d, i) => ({
                            x: i,
                            y: d * dapValues.length * dapClassWidth // Escalar para visualiza√ß√£o
                        })),
                        type: 'line',
                        borderColor: 'rgb(255, 160, 0)',
                        backgroundColor: 'rgba(255, 160, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Classes de DAP (cm)',
                                font: {
                                    size: responsiveOptions.titleFontSize
                                }
                            },
                            ticks: {
                                font: {
                                    size: responsiveOptions.fontSize
                                },
                                maxRotation: responsiveOptions.maxRotation,
                                minRotation: responsiveOptions.maxRotation
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Frequ√™ncia',
                                font: {
                                    size: responsiveOptions.titleFontSize
                                }
                            },
                            ticks: {
                                font: {
                                    size: responsiveOptions.fontSize
                                }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Informa√ß√µes do histograma de DAP
            document.getElementById('dapHistogramInfo').innerHTML = `
                <strong>Estat√≠sticas:</strong> N = ${dapValues.length} | 
                Classes (Sturges) = ${nClasses} | 
                Amplitude da classe = ${dapClassWidth.toFixed(1)} cm | 
                Intervalo = ${dapMin.toFixed(1)} - ${dapMax.toFixed(1)} cm
            `;
            
            // Dados de Altura
            const alturaValues = data.map(d => d.altura).filter(v => v && v > 0);

            if (alturaValues.length > 0) {
                // Calcular n√∫mero de classes para altura
                const nClassesAltura = Math.ceil(1 + 3.322 * Math.log10(alturaValues.length));

                // Calcular amplitude e tamanho das classes
                const alturaMin = Math.min(...alturaValues);
                const alturaMax = Math.max(...alturaValues);
                const alturaRange = alturaMax - alturaMin;
                const alturaClassWidth = alturaRange / nClassesAltura;

                // Criar classes e calcular frequ√™ncias
                const alturaClasses = [];
                const alturaFrequencies = [];
                const alturaDensities = [];

                for (let i = 0; i < nClassesAltura; i++) {
                    const lowerBound = alturaMin + (i * alturaClassWidth);
                    const upperBound = lowerBound + alturaClassWidth;

                    const frequency = alturaValues.filter(v =>
                        i === nClassesAltura - 1 ? v >= lowerBound && v <= upperBound : v >= lowerBound && v < upperBound
                    ).length;

                    alturaClasses.push(`${lowerBound.toFixed(1)}-${upperBound.toFixed(1)}`);
                    alturaFrequencies.push(frequency);
                    alturaDensities.push(frequency / (alturaValues.length * alturaClassWidth));
                }
                
                // Criar histograma de Altura
                const ctxHeight = document.getElementById('heightHistogram').getContext('2d');
                new Chart(ctxHeight, {
                    type: 'bar',
                    data: {
                        labels: alturaClasses,
                        datasets: [{
                            label: 'Frequ√™ncia',
                            data: alturaFrequencies,
                            backgroundColor: 'rgba(25, 118, 210, 0.6)',
                            borderColor: 'rgb(25, 118, 210)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        }, {
                            label: 'Densidade',
                            data: alturaDensities.map((d, i) => ({
                                x: i,
                                y: d * alturaValues.length * alturaClassWidth
                            })),
                            type: 'line',
                            borderColor: 'rgb(156, 39, 176)',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Classes de Altura (m)',
                                    font: {
                                        size: responsiveOptions.titleFontSize
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: responsiveOptions.fontSize
                                    },
                                    maxRotation: responsiveOptions.maxRotation,
                                    minRotation: responsiveOptions.maxRotation
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Frequ√™ncia',
                                    font: {
                                        size: responsiveOptions.titleFontSize
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: responsiveOptions.fontSize
                                    }
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                // Informa√ß√µes do histograma de Altura
                document.getElementById('heightHistogramInfo').innerHTML = `
                    <strong>Estat√≠sticas:</strong> N = ${alturaValues.length} |
                    Classes (Sturges) = ${nClassesAltura} |
                    Amplitude da classe = ${alturaClassWidth.toFixed(1)} m |
                    Intervalo = ${alturaMin.toFixed(1)} - ${alturaMax.toFixed(1)} m
                `;
            } else {
                // Se n√£o h√° dados de altura, mostrar mensagem
                const ctxHeight = document.getElementById('heightHistogram').getContext('2d');
                ctxHeight.font = '16px Arial';
                ctxHeight.fillStyle = '#999';
                ctxHeight.textAlign = 'center';
                ctxHeight.fillText('Dados de altura n√£o dispon√≠veis', 
                    ctxHeight.canvas.width / 2, 
                    ctxHeight.canvas.height / 2);
                
                document.getElementById('heightHistogramInfo').innerHTML = `
                    <strong>Sem dados de altura para an√°lise</strong>
                `;
            }
        }
        
        // Atualizar resumo
        function updateSummary() {
            const summaryGrid = document.getElementById('summaryGrid');
            const projectInfo = document.getElementById('projectInfo');

            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            const species = [...new Set(data.map(d => d.especie))];
            const totalBasalArea = data.reduce((sum, d) => sum + d.areaBasal, 0);
            
            // Usar o tamanho da parcela definido pelo usu√°rio
            const areaTotalHa = (parcelas.length * plotSizeM2) / 10000; // em hectares
            const areaBasalPorHa = totalBasalArea / areaTotalHa; // m¬≤/ha
            const densidadePorHa = data.length / areaTotalHa; // ind/ha
            
            // Estat√≠sticas de DAP
            const dapValues = data.map(d => d.dap).filter(v => v > 0);
            const dapMean = dapValues.reduce((a, b) => a + b, 0) / dapValues.length;
            const dapMin = Math.min(...dapValues);
            const dapMax = Math.max(...dapValues);
            const dapStd = Math.sqrt(dapValues.reduce((sum, v) => sum + Math.pow(v - dapMean, 2), 0) / dapValues.length);
            const dapCV = (dapStd / dapMean) * 100; // Coeficiente de varia√ß√£o
            
            // Estat√≠sticas de Altura (quando presente)
            const alturaValues = data.map(d => d.altura).filter(v => v && v > 0);
            let alturaStats = null;
            if (alturaValues.length > 0) {
                const alturaMean = alturaValues.reduce((a, b) => a + b, 0) / alturaValues.length;
                const alturaMin = Math.min(...alturaValues);
                const alturaMax = Math.max(...alturaValues);
                const alturaStd = Math.sqrt(alturaValues.reduce((sum, v) => sum + Math.pow(v - alturaMean, 2), 0) / alturaValues.length);
                const alturaCV = (alturaStd / alturaMean) * 100;
                alturaStats = {
                    n: alturaValues.length,
                    mean: alturaMean,
                    min: alturaMin,
                    max: alturaMax,
                    std: alturaStd,
                    cv: alturaCV
                };
            }
            
            summaryGrid.innerHTML = `
                <div class="summary-card">
                    <h3>Densidade</h3>
                    <div class="value">${densidadePorHa.toFixed(0)}<span class="unit">ind/ha</span></div>
                </div>
                <div class="summary-card">
                    <h3>Esp√©cies</h3>
                    <div class="value">${species.length}</div>
                </div>
                <div class="summary-card">
                    <h3>Parcelas</h3>
                    <div class="value">${parcelas.length}</div>
                </div>
                <div class="summary-card">
                    <h3>√Årea Basal</h3>
                    <div class="value">${areaBasalPorHa.toFixed(2)}<span class="unit">m¬≤/ha</span></div>
                </div>
            `;
            
            // Informa√ß√µes detalhadas
            let statsHTML = `
                <p><strong>Total de indiv√≠duos amostrados:</strong> ${data.length}</p>
                <p><strong>√Årea amostral total:</strong> ${areaTotalHa.toFixed(2)} ha (${parcelas.length} parcelas √ó ${plotSizeM2} m¬≤)</p>
                <p><strong>√Årea basal absoluta:</strong> ${totalBasalArea.toFixed(4)} m¬≤</p>
                <p><strong>Diversidade de Shannon (H'):</strong> ${processedData.diversity.shannon}</p>
                <p><strong>Equabilidade de Pielou (J):</strong> ${processedData.diversity.pielou}</p>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">
                    An√°lise Estat√≠stica - DAP
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                    <div><strong>M√©dia:</strong> ${dapMean.toFixed(1)} cm</div>
                    <div><strong>Desvio padr√£o:</strong> ${dapStd.toFixed(1)} cm</div>
                    <div><strong>M√≠nimo:</strong> ${dapMin.toFixed(1)} cm</div>
                    <div><strong>M√°ximo:</strong> ${dapMax.toFixed(1)} cm</div>
                    <div><strong>CV:</strong> ${dapCV.toFixed(1)}%</div>
                    <div><strong>N:</strong> ${dapValues.length}</div>
                </div>
            `;
            
            if (alturaStats) {
                statsHTML += `
                    <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 5px;">
                        An√°lise Estat√≠stica - Altura
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div><strong>M√©dia:</strong> ${alturaStats.mean.toFixed(1)} m</div>
                        <div><strong>Desvio padr√£o:</strong> ${alturaStats.std.toFixed(1)} m</div>
                        <div><strong>M√≠nimo:</strong> ${alturaStats.min.toFixed(1)} m</div>
                        <div><strong>M√°ximo:</strong> ${alturaStats.max.toFixed(1)} m</div>
                        <div><strong>CV:</strong> ${alturaStats.cv.toFixed(1)}%</div>
                        <div><strong>N:</strong> ${alturaStats.n} (${((alturaStats.n/data.length)*100).toFixed(0)}%)</div>
                    </div>
                `;
            }
            
            projectInfo.innerHTML = statsHTML;
            
            // Atualizar informa√ß√£o da √°rea ap√≥s processar dados
            updateAreaInfo();
        }
        
        // Criar tabela fitossociol√≥gica
        function createPhytoTable() {
            const table = document.getElementById('phytoTable');
            
            let html = `
                <thead>
                    <tr>
                        <th>Esp√©cie</th>
                        <th>N</th>
                        <th>DA<br>(ind/ha)</th>
                        <th>DR<br>(%)</th>
                        <th>FA<br>(%)</th>
                        <th>FR<br>(%)</th>
                        <th>DoA<br>(m¬≤/ha)</th>
                        <th>DoR<br>(%)</th>
                        <th>IVI</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            processedData.phytosociology.forEach(row => {
                html += `
                    <tr>
                        <td>${row.especie}</td>
                        <td>${row.n}</td>
                        <td>${row.da.toFixed(2)}</td>
                        <td>${row.dr.toFixed(2)}</td>
                        <td>${row.fa.toFixed(2)}</td>
                        <td>${row.fr.toFixed(2)}</td>
                        <td>${row.doa.toFixed(2)}</td>
                        <td>${row.dor.toFixed(2)}</td>
                        <td><strong>${row.ivi.toFixed(2)}</strong></td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        // Criar gr√°fico de curva de acumula√ß√£o
        function createAccumulationChart() {
            const ctx = document.getElementById('accumulationChart').getContext('2d');
            
            // Preparar dados para o gr√°fico com intervalo de confian√ßa
            const labels = processedData.accumulation.map(d => `${d.parcela}`);
            const mainData = processedData.accumulation.map(d => d.species);
            const lowerBound = processedData.accumulation.map(d => Math.max(0, d.min));
            const upperBound = processedData.accumulation.map(d => d.max);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Riqueza M√©dia',
                        data: mainData,
                        borderColor: 'rgb(46, 125, 50)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(46, 125, 50)'
                    }, {
                        label: 'IC 95% Superior',
                        data: upperBound,
                        borderColor: 'rgba(76, 175, 80, 0.3)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'IC 95% Inferior',
                        data: lowerBound,
                        borderColor: 'rgba(76, 175, 80, 0.3)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: '-1',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Curva de Acumula√ß√£o de Esp√©cies (100 permuta√ß√µes)'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    if (context.datasetIndex === 0) {
                                        const mean = context.parsed.y.toFixed(1);
                                        const std = processedData.accumulation[index].std.toFixed(2);
                                        return `Riqueza: ${mean} ¬± ${std}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de Esp√©cies'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'N√∫mero de Parcelas'
                            }
                        }
                    }
                }
            });
            
            // Interpreta√ß√£o com estimadores
            const lastPoint = processedData.accumulation[processedData.accumulation.length - 1];
            const penultimatePoint = processedData.accumulation[processedData.accumulation.length - 2];
            const slope = lastPoint.species - penultimatePoint.species;
            const est = processedData.estimators;
            
            let interpretation = `
                <strong>Riqueza observada:</strong> ${est.observed} esp√©cies em ${est.nParcelas} parcelas<br>
                <strong>Taxa de incremento:</strong> ${slope.toFixed(2)} esp√©cies/parcela (√∫ltima parcela) - ${((slope/est.observed)*100).toFixed(1)}% do total observado<br>
                <strong>Singletons:</strong> ${est.singletons} esp√©cies (em apenas 1 parcela)<br>
                <strong>Doubletons:</strong> ${est.doubletons} esp√©cies (em 2 parcelas)<br><br>
                
                <strong>Estimadores de Riqueza Total:</strong><br>
                ‚Ä¢ Chao 1: ${est.chao1.toFixed(0)} esp√©cies<br>
                ‚Ä¢ Chao 2 BC: ${est.chao2BC.toFixed(0)} esp√©cies<br>
                ‚Ä¢ Jackknife 1: ${est.jackknife1.toFixed(0)} esp√©cies<br>
                ‚Ä¢ Jackknife 2: ${est.jackknife2.toFixed(0)} esp√©cies<br>
                ‚Ä¢ Bootstrap: ${est.bootstrap.toFixed(0)} esp√©cies<br><br>
                
                <strong>Completude amostral:</strong> ${((est.observed / est.chao1) * 100).toFixed(1)}% (S‚ÇÄ/Chao1)
            `;
            
            document.getElementById('accumulationInterpretation').innerHTML = interpretation;
        }
        
        // Criar gr√°fico de diversidade
        function createDiversityChart() {
            const ctx = document.getElementById('diversityChart').getContext('2d');
            
            const speciesCount = {};
            data.forEach(row => {
                speciesCount[row.especie] = (speciesCount[row.especie] || 0) + 1;
            });
            
            const sortedSpecies = Object.entries(speciesCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedSpecies.map(s => s[0]),
                    datasets: [{
                        label: 'N√∫mero de Indiv√≠duos',
                        data: sortedSpecies.map(s => s[1]),
                        backgroundColor: 'rgba(25, 118, 210, 0.7)',
                        borderColor: 'rgb(25, 118, 210)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o de Abund√¢ncia das 10 Principais Esp√©cies'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'N√∫mero de Indiv√≠duos'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Esp√©cies'
                            }
                        }
                    }
                }
            });
        }
        
        // Criar gr√°fico de padr√£o espacial
        function createSpatialChart() {
            const ctx = document.getElementById('spatialChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: processedData.morisita.map(d => d.especie),
                    datasets: [{
                        label: '√çndice de Morisita',
                        data: processedData.morisita.map(d => parseFloat(d.morisita)),
                        backgroundColor: processedData.morisita.map(d => 
                            d.pattern === 'Agregado' ? 'rgba(255, 160, 0, 0.7)' :
                            d.pattern === 'Uniforme' ? 'rgba(76, 175, 80, 0.7)' :
                            'rgba(25, 118, 210, 0.7)'
                        ),
                        borderColor: processedData.morisita.map(d => 
                            d.pattern === 'Agregado' ? 'rgb(255, 160, 0)' :
                            d.pattern === 'Uniforme' ? 'rgb(76, 175, 80)' :
                            'rgb(25, 118, 210)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '√çndice de Morisita - Top 5 Esp√©cies'
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 1,
                                    yMax: 1,
                                    borderColor: 'rgb(255, 99, 132)',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '√çndice de Morisita'
                            }
                        }
                    }
                }
            });
            
            // Criar tabela de Morisita
            const table = document.getElementById('morisitaTable');
            let html = `
                <thead>
                    <tr>
                        <th>Esp√©cie</th>
                        <th>N¬∞ Indiv√≠duos</th>
                        <th>√çndice de Morisita</th>
                        <th>Limite Agrega√ß√£o</th>
                        <th>Limite Uniformidade</th>
                        <th>Padr√£o Espacial</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            processedData.morisita.forEach(row => {
                html += `
                    <tr>
                        <td>${row.especie}</td>
                        <td>${row.n}</td>
                        <td>${row.morisita}</td>
                        <td>${row.limAgr}</td>
                        <td>${row.limUni}</td>
                        <td><strong>${row.pattern}</strong></td>
                    </tr>
                `;
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        // Atualizar √≠ndices de diversidade
        function updateDiversityIndices() {
            document.getElementById('shannonIndex').textContent = processedData.diversity.shannon;
            document.getElementById('pielouIndex').textContent = processedData.diversity.pielou;
            document.getElementById('speciesRichness').textContent = processedData.diversity.richness;
            document.getElementById('simpsonIndex').textContent = processedData.diversity.simpson;
            
        }
        
        // Sistema de tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                // Atualizar tabs
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Atualizar conte√∫do
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Fun√ß√£o para exportar tabela como CSV
        function exportTableToCSV() {
            // Usar diretamente os dados processados para garantir formata√ß√£o correta
            if (!processedData.phytosociology || processedData.phytosociology.length === 0) {
                alert('N√£o h√° dados para exportar');
                return;
            }
            
            let csv = '\ufeff'; // BOM para UTF-8
            
            // Cabe√ßalho
            csv += 'Esp√©cie;N;DA (ind/ha);DR (%);FA (%);FR (%);DoA (m¬≤/ha);DoR (%);IVI\n';
            
            // Dados
            processedData.phytosociology.forEach(row => {
                const linha = [
                    row.especie,
                    row.n,
                    row.da.toFixed(2).replace('.', ','),
                    row.dr.toFixed(2).replace('.', ','),
                    row.fa.toFixed(2).replace('.', ','),
                    row.fr.toFixed(2).replace('.', ','),
                    row.doa.toFixed(2).replace('.', ','),
                    row.dor.toFixed(2).replace('.', ','),
                    row.ivi.toFixed(2).replace('.', ',')
                ];
                csv += linha.join(';') + '\n';
            });
            
            // Adicionar totais se necess√°rio
            const totals = {
                n: processedData.phytosociology.reduce((sum, r) => sum + r.n, 0),
                dr: processedData.phytosociology.reduce((sum, r) => sum + r.dr, 0),
                fr: processedData.phytosociology.reduce((sum, r) => sum + r.fr, 0),
                dor: processedData.phytosociology.reduce((sum, r) => sum + r.dor, 0),
                ivi: processedData.phytosociology.reduce((sum, r) => sum + r.ivi, 0)
            };
            
            csv += '\n'; // Linha em branco
            csv += `TOTAL;${totals.n};;${totals.dr.toFixed(2).replace('.', ',')};`;
            csv += `;${totals.fr.toFixed(2).replace('.', ',')};;${totals.dor.toFixed(2).replace('.', ',')};`;
            csv += `${totals.ivi.toFixed(2).replace('.', ',')}\n`;
            
            console.log('CSV exportado (primeiras linhas):');
            console.log(csv.split('\n').slice(0, 5).join('\n'));
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            // Nome do arquivo com data/hora
            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
            const timeStr = `${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            link.download = `tabela_fitossociologica_${dateStr}_${timeStr}.csv`;
            
            link.click();
        }
        
        // Fun√ß√£o para exportar gr√°fico
        function exportChart(chartId) {
            const canvas = document.getElementById(chartId);
            const link = document.createElement('a');
            link.download = chartId + '.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // ========== FUNCIONALIDADES DE BIOMASSA ==========

        const modelos = {
            none: {
                description: "Selecione um modelo para ver sua descri√ß√£o.",
                formula: null,
                report: () => "",
                outputColumnName: null,
            },
            pantropicalModel: {
                description: "Modelo Pantropical de Chave et al. (2014).",
                parametrization: "Florestas Pantropicais",
                requiredVariables: ["WD", "H", "DAP"],
                requiredVariablesInfo: {
                    WD: "densidade da madeira em g.cm-3",
                    H: "altura total da √°rvore em m",
                    DAP: "DAP em cm",
                },
                reference: "Chave, J., R√©jou‚ÄêM√©chain, M., B√∫rquez, A., Chidumayo, E., Colgan, M. S., Delitti, W. B., ... & Vieilledent, G. (2014). Improved allometric models to estimate the aboveground biomass of tropical trees. Global change biology, 20(10), 3177-3190.",
                formula: calculatePantropicalBiomass,
                report: (totalBiomass) => `Total de Biomassa pelo Modelo Pantropical: ${totalBiomass.toFixed(2)} toneladas`,
                outputColumnName: "AGB",
            },
            chambers2001: {
                description: "Modelo de Chambers et al. (2001), para Amaz√¥nia Central.",
                parametrization: "Amaz√¥nia Central - Terra-Firme",
                requiredVariables: ["DAP"],
                requiredVariablesInfo: {
                    DAP: "DAP em cm",
                },
                reference: "Chambers, J. Q., dos Santos, J., Ribeiro, R. J., & Higuchi, N. (2001). Tree damage, allometric relationships, and above-ground net primary production in central Amazon forest. Forest ecology and management, 152(1-3), 73-84.",
                formula: calculatechambers2001Biomass,
                report: (totalBiomass) => `Total de Biomassa pelo Modelo de Chambers et al. (2001): ${totalBiomass.toFixed(2)} toneladas`,
                outputColumnName: "AGB",
            },
            ziemmer2016: {
                description: "Biomassa de Xaxins (Dicksonia sellowiana e Cyathea corcovadensis) de Ziemmer et al. (2001)",
                parametrization: "Xaxim (Dicksonia sellowiana e Cyathea corcovadensis), FOM no Paran√°",
                requiredVariables: ["H", "DAP"],
                requiredVariablesInfo: {
                    H: "altura total da √°rvore em m",
                    DAP: "DAP em cm",
                },
                reference: "Ziemmer, J. K., Behling, A., & Dalla Corte, A. P. (2016). Quantifica√ß√£o da biomassa e dos teores de carbono de pterid√≥fitas arborescentes em floresta ombr√≥fila mista. biofix Scientific Journal, 1(1).",
                formula: calculateziemmer2016Biomass,
                report: (totalBiomass) => `Total de Biomassa Seca pelo Modelo de Ziemmer et al (2016): ${totalBiomass.toFixed(2)} toneladas`,
                outputColumnName: "AGB",
            },
            trautenmuller2021: {
                description: "Modelo (28) ajustado por Trautenmuller et al. (2021), pelo procedimento simult√¢neo ponderado, para biomassa acima do solo em Floresta Ombr√≥fila Mista, considerando diferentes componentes (Troncos, Galhos, Folhas e Total)",
                parametrization: "FOM no Paran√° e Rio Grande do Sul",
                requiredVariables: ["H", "DAP"],
                requiredVariablesInfo: {
                    H: "altura total da √°rvore em m",
                    DAP: "DAP em cm",
                },
                reference: "Trautenm√ºller, J. W., Netto, S. P., Balbinot, R., Watzlawick, L. F., Dalla Corte, A. P., Sanquetta, C. R., & Behling, A. (2021). Regression estimators for aboveground biomass and its constituent parts of trees in native southern Brazilian forests. Ecological Indicators, 130, 108025.",
                formula: calculatetrautenmuller2021Biomass,
                report: (totalBiomass) => `Total de Biomassa pelo Modelo 28 de Trautenm√ºller et al (2021): ${totalBiomass.toFixed(2)} toneladas`,
                outputColumnName: "AGB",
            },
        };

        function calculatePantropicalBiomass(row) {
            let WD = parseFloat(String(row["WD"]).replace(",", "."));
            let H = parseFloat(String(row["H"]).replace(",", "."));
            let DAP = parseFloat(String(row["DAP"]).replace(",", "."));
            let result = (0.0673 * Math.pow(WD * Math.pow(DAP, 2) * H, 0.976)) / 1000;
            return parseFloat(result.toFixed(4));
        }

        function calculatechambers2001Biomass(row) {
            let DAP = parseFloat(String(row["DAP"]).replace(",", "."));
            let logDAP = Math.log(DAP);
            let result = Math.exp(-0.37 + 0.333 * logDAP + 0.933 * Math.pow(logDAP, 2) - 0.122 * Math.pow(logDAP, 3)) / 1000;
            return parseFloat(result.toFixed(4));
        }

        function calculateziemmer2016Biomass(row) {
            let H = parseFloat(String(row["H"]).replace(",", "."));
            let DAP = parseFloat(String(row["DAP"]).replace(",", "."));
            let result = Math.exp(-3.17038 + 1.462132 * Math.log(DAP) + 1.183807 * Math.log(H) - 0.00004 * (Math.pow(DAP, 2) * H)) / 1000;
            return parseFloat(result.toFixed(4));
        }

        function calculateTrautenmullerTroncoBiomass(row) {
            let H = parseFloat(String(row["H"]).replace(",", "."));
            let DAP = parseFloat(String(row["DAP"]).replace(",", "."));
            let result = (0.028726 * (Math.pow(DAP, 1.675713) * Math.pow(H, 1.165411))) / 1000;
            return parseFloat(result.toFixed(4));
        }

        function calculateTrautenmullerGalhosBiomass(row) {
            let H = parseFloat(String(row["H"]).replace(",", "."));
            let DAP = parseFloat(String(row["DAP"]).replace(",", "."));
            let result = (0.003816 * Math.pow(Math.pow(DAP, 2) * H, 1.121684)) / 1000;
            return parseFloat(result.toFixed(4));
        }

        function calculateTrautenmullerFolhasBiomass(row) {
            let H = parseFloat(String(row["H"]).replace(",", "."));
            let DAP = parseFloat(String(row["DAP"]).replace(",", "."));
            let result = (0.014257 * Math.pow(Math.pow(DAP, 2) * H, 0.671907)) / 1000;
            return parseFloat(result.toFixed(4));
        }

        function calculatetrautenmuller2021Biomass(row) {
            let troncoBiomass = calculateTrautenmullerTroncoBiomass(row);
            let galhosBiomass = calculateTrautenmullerGalhosBiomass(row);
            let folhasBiomass = calculateTrautenmullerFolhasBiomass(row);
            let result = troncoBiomass + galhosBiomass + folhasBiomass;
            return parseFloat(result.toFixed(4));
        }

        function updateModelDescription(selectedValue) {
            let model = modelos[selectedValue];
            let descriptionElement = document.getElementById("modelDescription");
            let heightOptionsDiv = document.getElementById("heightMissingOptions");

            if (selectedValue === "none") {
                descriptionElement.textContent = model.description;
                heightOptionsDiv.style.display = "none";
                return;
            }

            descriptionElement.innerHTML = `
                <strong>Descri√ß√£o:</strong> ${model.description} <br>
                <strong>Parametriza√ß√£o:</strong> ${model.parametrization} <br>
                <strong>Vari√°veis necess√°rias:</strong>
                ${Object.entries(model.requiredVariablesInfo)
                    .map(([key, desc]) => `${key}: ${desc}`)
                    .join("<br>")} <br>
                <strong>Refer√™ncia Bibliogr√°fica:</strong> ${model.reference}
            `;

            // Verificar se o modelo requer altura e se h√° √°rvores sem altura
            if (data && data.length > 0 && model.requiredVariables.includes('H')) {
                const treesWithoutHeight = data.filter(row => !row.altura || row.altura <= 0);
                const treesWithHeight = data.filter(row => row.altura && row.altura > 0);

                if (treesWithoutHeight.length > 0 && treesWithHeight.length > 0) {
                    heightOptionsDiv.style.display = "block";

                    // Atualizar texto informativo
                    const infoText = heightOptionsDiv.querySelector('p');
                    infoText.innerHTML = `O modelo selecionado requer altura, mas <strong>${treesWithoutHeight.length}</strong> √°rvore(s) n√£o possuem essa medi√ß√£o
                        (${((treesWithoutHeight.length/data.length)*100).toFixed(1)}% do total).
                        <strong>${treesWithHeight.length}</strong> √°rvore(s) possuem altura medida.`;
                } else {
                    heightOptionsDiv.style.display = "none";
                }
            } else {
                heightOptionsDiv.style.display = "none";
            }
        }

        // Event listener para mudan√ßa de modelo
        document.addEventListener('DOMContentLoaded', function() {
            const modelSelect = document.getElementById("modelSelection");
            if (modelSelect) {
                modelSelect.addEventListener("change", function () {
                    updateModelDescription(this.value);
                });
            }
        });

        let biomassProcessedData = [];

        function executeBiomassCalculation() {
            if (!data || data.length === 0) {
                alert("Por favor, carregue um arquivo CSV primeiro.");
                return;
            }

            let selectedModel = modelos[document.getElementById("modelSelection").value];

            if (!selectedModel.formula) {
                alert("Por favor, selecione um modelo v√°lido.");
                return;
            }

            // Criar c√≥pia dos dados para n√£o modificar o original
            const dataForBiomass = JSON.parse(JSON.stringify(data));

            // Mapear nomes das colunas (o sistema usa 'dap' e 'altura', modelos esperam 'DAP' e 'H')
            dataForBiomass.forEach(row => {
                row.DAP = row.dap;
                row.H = row.altura;
                row.WD = 0.5; // Densidade da madeira padr√£o se n√£o fornecida
            });

            // Verificar quantos registros t√™m altura quando necess√°ria
            const requiresHeight = selectedModel.requiredVariables.includes('H');
            let validRecords = dataForBiomass;
            let skippedRecords = 0;
            let imputedRecords = 0;
            let meanHeight = null;

            if (requiresHeight) {
                const recordsWithHeight = dataForBiomass.filter(row => row.H && row.H > 0);
                const recordsWithoutHeight = dataForBiomass.filter(row => !row.H || row.H <= 0);
                skippedRecords = recordsWithoutHeight.length;

                if (recordsWithHeight.length === 0) {
                    alert("Erro: O modelo selecionado requer dados de altura, mas nenhuma √°rvore possui altura medida.");
                    return;
                }

                if (skippedRecords > 0) {
                    // Obter estrat√©gia escolhida pelo usu√°rio
                    const strategy = document.getElementById("missingHeightStrategy").value;

                    if (strategy === "exclude") {
                        // Excluir √°rvores sem altura
                        validRecords = recordsWithHeight;
                    } else if (strategy === "useMean") {
                        // Calcular altura m√©dia
                        meanHeight = recordsWithHeight.reduce((sum, row) => sum + row.H, 0) / recordsWithHeight.length;

                        // Imputar altura m√©dia nas √°rvores sem altura
                        recordsWithoutHeight.forEach(row => {
                            row.H = meanHeight;
                            row.heightImputed = true;
                        });

                        imputedRecords = recordsWithoutHeight.length;
                        validRecords = dataForBiomass; // Usar todos os registros
                        skippedRecords = 0; // N√£o h√° registros ignorados neste caso
                    }
                }
            }

            let totalBiomass = 0;
            let successCount = 0;
            let errorCount = 0;
            biomassProcessedData = [];

            validRecords.forEach((row) => {
                try {
                    let biomassOutput = selectedModel.formula(row);

                    // Verifica se o output √© um n√∫mero v√°lido
                    if (!isNaN(biomassOutput) && biomassOutput > 0) {
                        totalBiomass += biomassOutput;
                        row[selectedModel.outputColumnName] = biomassOutput;
                        successCount++;
                    } else {
                        row[selectedModel.outputColumnName] = null;
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Erro ao calcular biomassa para linha:', row, error);
                    row[selectedModel.outputColumnName] = null;
                    errorCount++;
                }

                biomassProcessedData.push(row);
            });

            if (totalBiomass === 0 || isNaN(totalBiomass)) {
                alert("Erro: N√£o foi poss√≠vel calcular biomassa para nenhuma √°rvore. Verifique os dados.");
                return;
            }

            // Calcular √°rea total em hectares
            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            const areaTotalHa = (parcelas.length * plotSizeM2) / 10000;

            // Biomassa por hectare
            const biomassPorHa = totalBiomass / areaTotalHa;

            // Calcular estat√≠sticas
            const biomassValues = biomassProcessedData
                .map(row => row[selectedModel.outputColumnName])
                .filter(v => v !== null && !isNaN(v) && v > 0);

            const biomassMean = biomassValues.reduce((a, b) => a + b, 0) / biomassValues.length;
            const biomassMin = Math.min(...biomassValues);
            const biomassMax = Math.max(...biomassValues);
            const biomassStd = Math.sqrt(
                biomassValues.reduce((sum, v) => sum + Math.pow(v - biomassMean, 2), 0) / biomassValues.length
            );
            const biomassCV = (biomassStd / biomassMean) * 100;

            // Calcular biomassa por esp√©cie
            const biomassBySpecies = {};
            biomassProcessedData.forEach(row => {
                const species = row.especie;
                const biomass = row[selectedModel.outputColumnName];

                if (!biomassBySpecies[species]) {
                    biomassBySpecies[species] = {
                        total: 0,
                        count: 0,
                        values: []
                    };
                }

                if (biomass !== null && !isNaN(biomass) && biomass > 0) {
                    biomassBySpecies[species].total += biomass;
                    biomassBySpecies[species].count++;
                    biomassBySpecies[species].values.push(biomass);
                }
            });

            // Processar estat√≠sticas por esp√©cie e ordenar por biomassa total
            const speciesStats = Object.entries(biomassBySpecies)
                .map(([species, data]) => {
                    const mean = data.total / data.count;
                    const std = Math.sqrt(
                        data.values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / data.count
                    );

                    return {
                        species: species,
                        total: data.total,
                        count: data.count,
                        mean: mean,
                        std: std,
                        percentage: (data.total / totalBiomass) * 100,
                        totalPerHa: data.total / areaTotalHa
                    };
                })
                .sort((a, b) => b.total - a.total);

            // Calcular biomassa acumulada
            let accumulatedPercentage = 0;
            speciesStats.forEach(sp => {
                accumulatedPercentage += sp.percentage;
                sp.accumulated = accumulatedPercentage;
            });

            // Identificar quantas esp√©cies representam 80% da biomassa
            const species80Index = speciesStats.findIndex(sp => sp.accumulated >= 80);
            const species80Count = species80Index >= 0 ? species80Index + 1 : speciesStats.length;

            // Mostrar resultados com estat√≠sticas
            document.getElementById("biomassReport").innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: rgba(255,255,255,0.6); padding: 15px; border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">BIOMASSA TOTAL</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                            ${totalBiomass.toFixed(2)} <span style="font-size: 14px; font-weight: normal;">ton</span>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.6); padding: 15px; border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">BIOMASSA POR HECTARE</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                            ${biomassPorHa.toFixed(2)} <span style="font-size: 14px; font-weight: normal;">ton/ha</span>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.6); padding: 15px; border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">√ÅRVORES CALCULADAS</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                            ${successCount} <span style="font-size: 14px; font-weight: normal;">de ${validRecords.length}</span>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.6); padding: 15px; border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">ESP√âCIES (80% BIOMASSA)</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">
                            ${species80Count} <span style="font-size: 14px; font-weight: normal;">de ${speciesStats.length}</span>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.6); padding: 15px; border-radius: 6px; margin-top: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary-dark);">Estat√≠sticas de Biomassa Individual</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;">
                        <div><strong>M√©dia:</strong> ${biomassMean.toFixed(4)} ton</div>
                        <div><strong>Desvio padr√£o:</strong> ${biomassStd.toFixed(4)} ton</div>
                        <div><strong>M√≠nimo:</strong> ${biomassMin.toFixed(4)} ton</div>
                        <div><strong>M√°ximo:</strong> ${biomassMax.toFixed(4)} ton</div>
                        <div><strong>CV:</strong> ${biomassCV.toFixed(1)}%</div>
                        <div><strong>N:</strong> ${biomassValues.length}</div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.6); padding: 15px; border-radius: 6px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--primary-dark);">Biomassa por Esp√©cie</h4>

                    ${speciesStats.length > 1 ? `
                        <p style="font-size: 13px; color: var(--text-light); margin-bottom: 15px;">
                            <strong>Concentra√ß√£o:</strong> ${species80Count} esp√©cie(s) concentram 80% da biomassa total
                            (${((species80Count/speciesStats.length)*100).toFixed(1)}% das esp√©cies)
                        </p>
                    ` : ''}

                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;">
                        <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                            <thead style="position: sticky; top: 0; z-index: 1;">
                                <tr style="background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);">
                                    <th style="padding: 10px 8px; text-align: left; color: white; font-weight: 500;">#</th>
                                    <th style="padding: 10px 8px; text-align: left; color: white; font-weight: 500;">Esp√©cie</th>
                                    <th style="padding: 10px 8px; text-align: right; color: white; font-weight: 500;">N</th>
                                    <th style="padding: 10px 8px; text-align: right; color: white; font-weight: 500;">Biomassa Total (ton)</th>
                                    <th style="padding: 10px 8px; text-align: right; color: white; font-weight: 500;">Biomassa/ha</th>
                                    <th style="padding: 10px 8px; text-align: right; color: white; font-weight: 500;">% Total</th>
                                    <th style="padding: 10px 8px; text-align: right; color: white; font-weight: 500;">% Acum.</th>
                                    <th style="padding: 10px 8px; text-align: right; color: white; font-weight: 500;">M√©dia ¬± DP</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${speciesStats.map((sp, index) => `
                                    <tr style="border-bottom: 1px solid var(--border-color); ${index < species80Index ? 'background: rgba(76, 175, 80, 0.05);' : ''}">
                                        <td style="padding: 8px;">${index + 1}</td>
                                        <td style="padding: 8px; font-weight: ${index < 3 ? 'bold' : 'normal'};">${sp.species}</td>
                                        <td style="padding: 8px; text-align: right;">${sp.count}</td>
                                        <td style="padding: 8px; text-align: right;">${sp.total.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: right;">${sp.totalPerHa.toFixed(3)}</td>
                                        <td style="padding: 8px; text-align: right; font-weight: ${sp.percentage > 20 ? 'bold' : 'normal'};">${sp.percentage.toFixed(1)}%</td>
                                        <td style="padding: 8px; text-align: right;">${sp.accumulated.toFixed(1)}%</td>
                                        <td style="padding: 8px; text-align: right; font-size: 11px;">${sp.mean.toFixed(4)} ¬± ${sp.std.toFixed(4)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    ${speciesStats.length > 1 ? `
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
                            <strong>Legenda:</strong> Linhas em verde claro = esp√©cies que comp√µem os primeiros 80% da biomassa
                        </p>
                    ` : ''}
                </div>

                ${skippedRecords > 0 ? `
                    <div style="background: rgba(255, 160, 0, 0.1); padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 3px solid var(--warning-color);">
                        <strong>‚ö†Ô∏è Aviso:</strong> ${skippedRecords} √°rvore(s) foram ignoradas por n√£o possu√≠rem altura.
                    </div>
                ` : ''}

                ${imputedRecords > 0 ? `
                    <div style="background: rgba(25, 118, 210, 0.1); padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 3px solid var(--accent-color);">
                        <strong>‚ÑπÔ∏è Imputa√ß√£o de Dados:</strong> ${imputedRecords} √°rvore(s) sem altura tiveram altura m√©dia imputada (${meanHeight.toFixed(2)} m).
                        Esta abordagem assume homogeneidade da floresta.
                    </div>
                ` : ''}

                ${errorCount > 0 ? `
                    <div style="background: rgba(211, 47, 47, 0.1); padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 3px solid var(--error-color);">
                        <strong>‚ö†Ô∏è Erro:</strong> ${errorCount} √°rvore(s) geraram erro no c√°lculo.
                    </div>
                ` : ''}

                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 13px; color: var(--text-light);">
                    <strong>√Årea amostrada:</strong> ${areaTotalHa.toFixed(2)} ha (${parcelas.length} parcelas √ó ${plotSizeM2} m¬≤)
                </div>
            `;

            document.getElementById("biomassResults").style.display = "block";
        }

        function exportBiomassData() {
            if (!biomassProcessedData || biomassProcessedData.length === 0) {
                alert("Nenhum dado para exportar.");
                return;
            }

            const selectedModel = document.getElementById("modelSelection").value;
            const modelInfo = modelos[selectedModel];

            // Preparar dados para exporta√ß√£o
            const exportData = biomassProcessedData.map(row => ({
                'Parcela': row.parcela,
                'ID √Årvore': row.idArvore,
                'Esp√©cie': row.especie,
                'CAP (cm)': row.cap ? row.cap.toFixed(1).replace('.', ',') : '',
                'DAP (cm)': row.DAP ? row.DAP.toFixed(1).replace('.', ',') : '',
                'Altura (m)': row.H ? row.H.toFixed(1).replace('.', ',') : '',
                'Altura Imputada': row.heightImputed ? 'Sim' : 'N√£o',
                'AGB (ton)': row[modelInfo.outputColumnName] ? row[modelInfo.outputColumnName].toFixed(4).replace('.', ',') : ''
            }));

            // Adicionar BOM UTF-8
            let csv = '\ufeff';

            // Converter para CSV usando Papa Parse
            csv += Papa.unparse(exportData, {
                delimiter: ";",
            });

            // Adicionar informa√ß√µes do modelo no final
            const totalBiomass = biomassProcessedData
                .map(r => r[modelInfo.outputColumnName])
                .filter(v => v !== null && !isNaN(v))
                .reduce((a, b) => a + b, 0);

            const parcelas = [...new Set(data.map(d => d.parcela).filter(p => p && p.toString().trim() !== ''))];
            const areaTotalHa = (parcelas.length * plotSizeM2) / 10000;
            const biomassPorHa = totalBiomass / areaTotalHa;

            // Calcular estat√≠sticas por esp√©cie para o CSV
            const biomassBySpecies = {};
            biomassProcessedData.forEach(row => {
                const species = row.especie;
                const biomass = row[modelInfo.outputColumnName];

                if (!biomassBySpecies[species]) {
                    biomassBySpecies[species] = {
                        total: 0,
                        count: 0
                    };
                }

                if (biomass !== null && !isNaN(biomass) && biomass > 0) {
                    biomassBySpecies[species].total += biomass;
                    biomassBySpecies[species].count++;
                }
            });

            const speciesStatsForExport = Object.entries(biomassBySpecies)
                .map(([species, data]) => ({
                    species: species,
                    total: data.total,
                    count: data.count,
                    percentage: (data.total / totalBiomass) * 100,
                    totalPerHa: data.total / areaTotalHa
                }))
                .sort((a, b) => b.total - a.total);

            // Verificar se houve imputa√ß√£o ou exclus√£o
            const treesWithImputedHeight = biomassProcessedData.filter(row => row.heightImputed).length;
            const originalTreeCount = data.length;
            const treesExcluded = originalTreeCount - biomassProcessedData.length;

            csv += '\n\n;INFORMA√á√ïES DO MODELO\n';
            csv += `;Modelo: ${modelInfo.description}\n`;
            csv += `;Parametriza√ß√£o: ${modelInfo.parametrization}\n`;
            csv += `;Refer√™ncia: ${modelInfo.reference}\n`;

            csv += '\n;TRATAMENTO DE DADOS\n';
            if (treesWithImputedHeight > 0) {
                const meanH = biomassProcessedData.find(row => row.heightImputed)?.H || 0;
                csv += `;Estrat√©gia para √°rvores sem altura: Imputa√ß√£o com altura m√©dia\n`;
                csv += `;√Årvores com altura imputada: ${treesWithImputedHeight}\n`;
                csv += `;Altura m√©dia utilizada: ${meanH.toFixed(2)} m\n`;
            } else if (treesExcluded > 0) {
                csv += `;Estrat√©gia para √°rvores sem altura: Exclus√£o do c√°lculo\n`;
                csv += `;√Årvores exclu√≠das: ${treesExcluded}\n`;
            } else {
                csv += `;Todas as √°rvores possu√≠am dados completos\n`;
            }

            csv += '\n;RESULTADOS GERAIS\n';
            csv += `;Biomassa Total: ${totalBiomass.toFixed(2)} toneladas\n`;
            csv += `;Biomassa por Hectare: ${biomassPorHa.toFixed(2)} ton/ha\n`;
            csv += `;√Årea Amostrada: ${areaTotalHa.toFixed(2)} ha\n`;
            csv += `;N√∫mero de √Årvores Calculadas: ${biomassProcessedData.length}\n`;
            csv += `;N√∫mero de √Årvores Originais: ${originalTreeCount}\n`;
            csv += `;Data do C√°lculo: ${new Date().toLocaleString('pt-BR')}\n`;

            // Adicionar tabela de biomassa por esp√©cie
            csv += '\n\n;BIOMASSA POR ESP√âCIE\n';
            csv += ';Esp√©cie;N;Biomassa Total (ton);Biomassa/ha (ton/ha);% do Total\n';
            speciesStatsForExport.forEach(sp => {
                csv += `;${sp.species};${sp.count};${sp.total.toFixed(3).replace('.', ',')};${sp.totalPerHa.toFixed(3).replace('.', ',')};${sp.percentage.toFixed(1).replace('.', ',')}%\n`;
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const downloadBtn = document.createElement("a");

            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`;
            const timeStr = `${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;

            downloadBtn.setAttribute("href", url);
            downloadBtn.setAttribute("download", `biomassa_${selectedModel}_${dateStr}_${timeStr}.csv`);
            downloadBtn.click();
        }
    </script>
</body>
</html>
